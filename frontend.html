<!-- ASDForecast v147.0 // UI: LOTTERY + REFERRAL + EXTERNAL TRACKING MERGE -->
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://unpkg.com/@solana/web3.js@latest/lib/index.iife.min.js"></script>
<link href="https://fonts.googleapis.com/css2?family=Comic+Neue:wght@400;700&family=JetBrains+Mono:wght@400;700&display=swap" rel="stylesheet">

<style>
    /* THEME: Terminal / Fire */
    #asd-app {
        font-family: 'Comic Neue', cursive; 
        background-color: #451a03; 
        color: #ffedd5;
        min-height: 1950px;
        position: relative;
        border: 6px solid #7c2d12;
        border-radius: 16px;
        overflow: hidden;
    }
    #asd-app .font-mono { font-family: 'JetBrains Mono', monospace; }

    .panel {
        background: rgba(20, 10, 5, 0.6);
        border: 2px solid #ea580c;
        border-radius: 8px;
        box-shadow: 4px 4px 0 #9a3412;
    }

    .ticker-wrap { width: 100%; background-color: #2a1005; border-bottom: 2px solid #7c2d12; overflow: hidden; white-space: nowrap; height: 32px; display: flex; align-items: center; }
    .ticker { display: inline-block; padding-left: 100%; animation: marquee 27s linear infinite; font-family: 'JetBrains Mono', monospace; font-size: 12px; }
    .ticker-wrap:hover .ticker { animation-duration: 54s; }
    .ticker-item { display: inline-block; padding: 0 20px; color: #fb923c; }
    @keyframes marquee { 0% { transform: translate(0, 0); } 100% { transform: translate(-100%, 0); } }

    .bar-container { height: 24px; background: #2a1005; border-radius: 12px; overflow: hidden; border: 1px solid #7c2d12; display: flex; }
    .bar-fill { height: 100%; transition: width 0.5s ease; }
    .bg-up { background: #22c55e; }
    .bg-down { background: #ef4444; }

    .input-qty { background: #2a1005; border: 2px solid #ea580c; color: white; text-align: center; font-family: 'JetBrains Mono'; font-size: 1.25rem; outline: none; }
    .input-qty:focus { border-color: #fb923c; }
    input[type=number]::-webkit-inner-spin-button { -webkit-appearance: none; }

    .btn-market { text-transform: uppercase; font-weight: bold; transition: all 0.1s; border: 2px solid; }
    .btn-market:active:not(:disabled) { transform: translate(2px, 2px); }
    .btn-market:disabled { opacity: 0.5; cursor: not-allowed; filter: grayscale(100%); transform: none; }
    
    .btn-up { background: #14532d; border-color: #22c55e; color: #4ade80; }
    .btn-up:hover:not(:disabled) { background: #166534; }
    .btn-down { background: #7f1d1d; border-color: #ef4444; color: #fca5a5; }
    .btn-down:hover:not(:disabled) { background: #991b1b; }

    /* MODAL STYLES */
    #share-modal, #history-modal { backdrop-filter: blur(5px); }
    .share-card { background: #1a0f0a; border: 2px solid #ea580c; padding: 20px; border-radius: 12px; max-width: 90%; width: 500px; text-align: center; }
    #share-preview { width: 100%; border-radius: 8px; border: 2px solid #7c2d12; margin-bottom: 15px; }
    
    /* HISTORY MODAL SPECIFIC */
    .history-card { background: #1a0f0a; border: 2px solid #ea580c; border-radius: 12px; width: 90%; max-width: 900px; height: 80vh; display: flex; flex-direction: column; overflow: hidden; box-shadow: 0 20px 50px rgba(0,0,0,0.8); }

    #wallet-modal { z-index: 9999; }
    
    /* SCROLLBARS */
    .custom-scroll::-webkit-scrollbar { width: 8px; }
    .custom-scroll::-webkit-scrollbar-track { background: #2a1005; }
    .custom-scroll::-webkit-scrollbar-thumb { background: #ea580c; border-radius: 4px; }

    /* BROADCAST STYLE */
    .broadcast-box {
        background: rgba(251, 146, 60, 0.1);
        border: 1px solid #ea580c;
        color: #fdba74;
        animation: pulse-border 2s infinite;
    }
    @keyframes pulse-border { 0% { border-color: #ea580c; } 50% { border-color: #fff7ed; } 100% { border-color: #ea580c; } }
    
    /* SENTIMENT METER STYLES */
    .sent-btn {
        width: 60px; height: 60px;
        border-radius: 8px; /* SQUARE BOX */
        border: 2px solid #444;
        transition: transform 0.1s, border-color 0.2s;
        overflow: hidden;
        background: #000;
        cursor: pointer;
    }
    .sent-btn:active:not(:disabled) { transform: scale(0.95); }
    .sent-btn:disabled { opacity: 0.5; filter: grayscale(100%); cursor: not-allowed; }
    .sent-btn-up:hover:not(:disabled) { border-color: #22c55e; }
    .sent-btn-down:hover:not(:disabled) { border-color: #ef4444; }
    .sent-img { width: 100%; height: 100%; object-fit: cover; }
</style>

<div id="asd-app">
    <div class="ticker-wrap"><div id="ticker-content" class="ticker"><div class="ticker-item">Watching the world burn...</div></div></div>

    <div class="p-6">
        <div class="flex flex-col md:flex-row justify-between items-center mb-8 border-b-4 border-orange-900 pb-4">
            <div class="flex items-center gap-4 mb-4 md:mb-0">
                <div class="text-6xl animate-bounce">üî•</div>
                <div>
                    <h1 class="text-4xl font-bold text-white">ASDForecast</h1>
                    <p class="text-orange-300">15m Solana Binary Prediction Market</p>
                </div>
            </div>
            <div class="flex items-center gap-4">
                <div id="admin-broadcast-container" class="hidden broadcast-box px-4 py-2 rounded text-xs font-mono font-bold uppercase tracking-wide">
                    üì¢ <span id="broadcast-text"></span>
                </div>

                <div class="flex flex-col items-end">
                    <div id="top-status-indicator" class="flex items-center gap-2 text-xs font-mono bg-black/40 px-3 py-2 rounded border border-red-900/50 text-red-500 transition-colors duration-500">
                        <span id="status-dot" class="w-2 h-2 rounded-full bg-red-500 animate-pulse"></span>
                        <span id="status-text">OFFLINE</span>
                    </div>
                    <div id="last-updated" class="text-[10px] font-mono text-orange-500/50 mt-1 mr-1">Price Data: --:--:--</div>
                </div>
                <button id="connect-btn" class="bg-orange-600 border-2 border-orange-800 text-white px-6 py-2 rounded shadow-lg font-bold hover:bg-orange-500">Connect Phantom</button>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-12 gap-8 mb-8">
            <div class="lg:col-span-7 space-y-6">
                <div class="panel p-6">
                    <div class="flex justify-between items-start">
                        <div>
                            <h3 class="text-xs font-bold text-orange-500 uppercase">SOL/USD (15m Change)</h3>
                            <div class="flex items-baseline gap-3">
                                <span id="price" class="text-5xl font-mono font-bold text-white">$---.--</span>
                                <span id="change" class="text-2xl font-mono font-bold">--</span>
                            </div>
                            <div class="mt-2 text-[10px] font-mono text-orange-500/70 flex gap-4">
                                <span>OPEN: <span id="frame-start" class="text-white">SYNCING...</span></span>
                                <span>CLOSE: <span id="frame-end" class="text-white">SYNCING...</span></span>
                            </div>
                        </div>
                        <div class="text-right">
                            <h3 class="text-xs font-bold text-orange-500 uppercase">Next Reset</h3>
                            <div id="timer" class="text-4xl font-mono font-bold text-yellow-400">--:--</div>
                        </div>
                    </div>
                </div>

                <div class="panel p-6 bg-black/20 relative">
                    <h3 id="net-shares-header" class="text-lg font-bold text-white mb-4 text-center">Share Market</h3>
                    <div class="flex justify-between text-sm font-bold font-mono text-white mb-1">
                        <span class="text-green-400">UP: <span id="lbl-shares-up">0</span></span>
                        <span class="text-red-400">DOWN: <span id="lbl-shares-down">0</span></span>
                    </div>
                    <div class="bar-container mb-4">
                        <div id="bar-up" class="bar-fill bg-up" style="width: 50%"></div>
                        <div id="bar-down" class="bar-fill bg-down" style="width: 50%"></div>
                    </div>
                    <div class="grid grid-cols-2 gap-4 text-center text-xs font-mono text-orange-500/80">
                        <div><div class="text-sm font-bold text-white">Price: <span id="lbl-price-up">0.050</span> SOL</div><div class="flex justify-center gap-2 mt-1 text-[10px]"><span>1m: <span id="up-1m">0%</span></span><span>5m: <span id="up-5m">0%</span></span></div></div>
                        <div><div class="text-sm font-bold text-white">Price: <span id="lbl-price-down">0.050</span> SOL</div><div class="flex justify-center gap-2 mt-1 text-[10px]"><span>1m: <span id="down-1m">0%</span></span><span>5m: <span id="down-5m">0%</span></span></div></div>
                    </div>
                    <div class="mt-4 flex justify-center items-center gap-2">
                        <div class="bg-black/40 border border-orange-900/30 rounded px-4 py-1 text-center shadow-inner">
                            <span class="text-[10px] text-orange-400 uppercase block tracking-widest opacity-70">Current Frame Pot</span>
                            <span id="current-pot" class="text-lg font-mono font-bold text-white">0.000 SOL</span>
                        </div>
                        <div class="text-xs text-orange-500/70 font-mono" id="frame-users-container">
                            (üë§ <span id="frame-users">0</span>)
                        </div>
                    </div>
                </div>

                <div class="panel p-6 bg-black/40">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-lg font-bold text-white">Previous Frames</h3>
                        <button onclick="openHistoryModal()" class="text-xs bg-orange-900 text-orange-200 px-3 py-1 rounded hover:bg-orange-800 font-mono font-bold border border-orange-700">VIEW HISTORY (50) ‚§¢</button>
                    </div>
                    <div class="overflow-hidden">
                        <table class="w-full text-sm font-mono text-left">
                            <thead class="text-orange-500 border-b border-orange-900/50 sticky top-0 bg-[#1d120e] z-10"><tr><th class="pb-2">Time (Close)</th><th class="pb-2">Result</th><th class="pb-2">Open</th><th class="pb-2">Close</th><th class="pb-2">Volume</th><th class="pb-2">Your Status</th></tr></thead>
                            <tbody id="history-rows" class="text-orange-200/80"><tr><td colspan="6" class="py-2 italic opacity-50">Waiting for first frame close...</td></tr></tbody>
                        </table>
                    </div>
                </div>

                <div class="panel p-6 bg-black/40 border-orange-900/30 border-2 hidden">
                    <div class="flex justify-between items-center mb-4">
                         <h3 class="text-sm font-bold text-orange-400 uppercase tracking-wider">Daily Crowd Sentiment</h3>
                         <span class="text-[10px] font-mono text-gray-500" id="sent-timer">Reset: --:--</span>
                    </div>
                    
                    <div class="flex items-center gap-4">
                        <button id="btn-sent-up" onclick="voteSentiment('UP')" class="sent-btn sent-btn-up" title="Vote Up">
                            <img id="img-sent-up" src="" class="sent-img" alt="UP" onerror="this.style.display='none'">
                        </button>
                        
                        <div class="flex-grow h-4 bg-gray-900 rounded-full overflow-hidden border border-gray-700 relative">
                            <div id="sent-bar-fill" class="h-full bg-green-500 transition-all duration-500" style="width: 50%"></div>
                            <div class="absolute top-0 bottom-0 left-1/2 w-0.5 bg-black/50"></div>
                        </div>
                        
                        <button id="btn-sent-down" onclick="voteSentiment('DOWN')" class="sent-btn sent-btn-down" title="Vote Down">
                            <img id="img-sent-down" src="" class="sent-img" alt="DOWN" onerror="this.style.display='none'">
                        </button>
                    </div>
                    
                    <div class="flex justify-between text-[10px] font-mono text-gray-400 mt-2 px-2">
                        <span>UP: <span id="val-sent-up" class="text-green-400 font-bold">0</span></span>
                        <span>DOWN: <span id="val-sent-down" class="text-red-400 font-bold">0</span></span>
                    </div>
                    <p class="text-[9px] text-center mt-3 text-gray-600 font-mono">Vote once per 15 mins. Resets daily.</p>
                </div>

            </div>

            <div class="lg:col-span-5">
                <div class="panel h-full p-6 flex flex-col justify-between bg-[#2a1208]">
                    <div class="mb-6 border-b border-orange-900/50 pb-4">
                        <div class="flex justify-between items-center text-xs text-orange-400 font-mono mb-1"><span>AVAILABLE BALANCE</span><div class="flex items-center gap-3"><button id="disconnect-btn" class="text-red-500 hover:text-red-400 underline hidden font-bold">[ DISCONNECT ]</button><button onclick="refreshBalance()" class="hover:text-white" title="Refresh">‚Üª</button></div></div>
                        <div class="text-2xl font-mono font-bold text-white mb-4"><span id="balance">0.0000</span> SOL</div>

                        <div id="user-stats-container" class="hidden space-y-3">
                            <div class="flex gap-2">
                                <div class="grid grid-cols-2 gap-2 text-xs font-mono bg-black/30 p-2 rounded flex-grow">
                                    <div><span class="text-orange-500 block">WIN RATE</span><span id="stat-winrate" class="text-white font-bold text-lg">0%</span></div>
                                    <div><span class="text-orange-500 block">TOTAL WAGERED</span><span id="stat-volume" class="text-white font-bold text-lg">0 SOL</span></div>
                                </div>
                                <button onclick="openShareModal()" class="bg-blue-900/50 border border-blue-500/50 text-blue-200 px-3 rounded hover:bg-blue-800 transition-colors text-xs font-bold flex flex-col items-center justify-center">
                                    <span>üì∏</span>SHARE
                                </button>
                            </div>
                            
                            <div class="bg-orange-900/20 p-2 rounded border border-orange-500/30 text-xs font-mono">
                                <span class="text-orange-400 block mb-1 uppercase tracking-wider">Current Frame Position</span>
                                <div class="flex justify-between mb-1">
                                    <span class="text-green-400">UP: <span id="stat-active-up">0</span> <span id="stat-active-up-sol" class="text-gray-500"></span></span>
                                    <span class="text-red-400">DOWN: <span id="stat-active-down">0</span> <span id="stat-active-down-sol" class="text-gray-500"></span></span>
                                </div>
                                <div class="flex justify-between items-center border-t border-orange-500/20 pt-1 mt-1"><span class="text-orange-300/70">Est. Win Payout:</span><span id="stat-payout" class="text-yellow-400 font-bold">0.00 SOL</span></div>
                            </div>
                            
                            <div class="bg-orange-900/20 p-2 rounded border border-orange-900/50 text-xs font-mono flex justify-between items-center gap-2">
                                <div class="flex-grow">
                                    <span class="text-gray-400 block mb-1 uppercase tracking-wider text-[10px]">YOUR LAST FRAME RESULTS</span>
                                    <div id="last-frame-data" class="text-orange-200 italic opacity-50">Waiting for close...</div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div id="order-form" class="opacity-50 pointer-events-none relative">
                        <div id="pause-overlay" class="hidden absolute inset-0 bg-black/80 z-50 flex flex-col items-center justify-center text-center rounded"><span class="text-3xl">üõë</span><span id="pause-text" class="text-red-500 font-bold text-xl">MARKET PAUSED</span><span class="text-xs text-orange-300 mt-2">Maintenance / Refund Mode</span></div>
                        <h2 class="text-xl font-bold text-white mb-4">Fuel the Fire</h2>
                        <div class="mb-6">
                            <label class="block text-xs font-bold text-orange-500 uppercase mb-2">Kindling (Shares)</label>
                            <div class="flex items-center gap-2"><button id="btn-dec" class="w-10 h-10 bg-orange-900 text-white rounded font-bold hover:bg-orange-800">-</button><input type="number" id="qty-input" class="input-qty w-full p-2 rounded" value="10" min="1" step="1"><button id="btn-inc" class="w-10 h-10 bg-orange-900 text-white rounded font-bold hover:bg-orange-800">+</button></div>
                        </div>
                        <div class="grid grid-cols-2 gap-4 mb-4">
                            <div class="bg-green-900/20 p-2 rounded border border-green-900/50 text-center"><div class="text-[10px] text-green-400 uppercase">Burn Rate (UP)</div><div id="cost-up" class="text-lg font-mono font-bold text-green-300">0.000 SOL</div></div>
                            <div class="bg-red-900/20 p-2 rounded border border-red-900/50 text-center"><div class="text-[10px] text-red-400 uppercase">Burn Rate (DOWN)</div><div id="cost-down" class="text-lg font-mono font-bold text-red-300">0.000 SOL</div></div>
                        </div>
                        <div class="space-y-3">
                            <button id="btn-buy-up" onclick="buy('UP')" class="btn-market btn-up w-full py-4 rounded shadow-lg text-left px-4 hover:border-green-400 transition-all group"><span class="text-xl font-bold block">IT'S FINE (UP) üìà</span><span class="text-[10px] font-mono opacity-70 group-hover:opacity-100">I am okay with the events that are unfolding.</span></button>
                            <button id="btn-buy-down" onclick="buy('DOWN')" class="btn-market btn-down w-full py-4 rounded shadow-lg text-left px-4 hover:border-red-400 transition-all group"><span class="text-xl font-bold block">IT BURNS (DOWN) üî•</span><span class="text-[10px] font-mono opacity-70 group-hover:opacity-100">Everything is melting.</span></button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="panel p-4 bg-black/40 mb-8">
            <h3 class="text-xs font-bold text-orange-500 uppercase tracking-wider mb-2">Global Damage Report</h3>
            <div class="grid grid-cols-2 md:grid-cols-3 gap-6 text-center md:text-left">
                <div><span class="block text-[10px] text-orange-400 font-mono uppercase">Lifetime Volume</span><span id="global-vol" class="text-xl font-bold font-mono text-white">0.00 SOL</span></div>
                <div><span class="block text-[10px] text-orange-400 font-mono uppercase">Lifetime Fees</span><span id="global-fees" class="text-xl font-bold font-mono text-red-400">0.00 SOL</span></div>
                <div><span class="block text-[10px] text-orange-400 font-mono uppercase">ASDF Purchased</span><span id="global-asdf" class="text-xl font-bold font-mono text-yellow-400">0 ASDF</span></div>
                
                <div>
                    <span class="block text-[10px] text-orange-400 font-mono uppercase">Last Payout</span>
                    <a id="link-last-payout" href="https://solscan.io/account/BXSp5y6Ua6tB5fZDe1EscVaaEaZLg1yqzrsPqAXhKJYy" target="_blank" class="text-xl font-bold font-mono text-white hover:text-orange-400 transition-colors underline decoration-dotted decoration-orange-900" title="Verify on Solscan">--</a>
                </div>
                <div><span class="block text-[10px] text-orange-400 font-mono uppercase">Lifetime Payouts</span><span id="global-winnings" class="text-xl font-bold font-mono text-green-400">0.00 SOL</span></div>
                <div><span class="block text-[10px] text-orange-400 font-mono uppercase">Lifetime Degens</span><span id="global-lifetime-users" class="text-xl font-bold font-mono text-yellow-400">0</span></div>
            </div>
        </div>

        <div class="panel p-6 bg-black/40 mb-8">
            <h3 class="text-lg font-bold text-white mb-4">üèÜ Top 5 Degens</h3>
            <div class="overflow-x-auto">
                <table class="w-full text-sm font-mono text-left">
                    <thead class="text-orange-500 border-b border-orange-900/50">
                        <tr>
                            <th class="pb-2">User</th>
                            <th class="pb-2 text-right">Bets</th>
                            <th class="pb-2 text-right">Win %</th>
                            <th class="pb-2 text-right">Total Won</th>
                        </tr>
                    </thead>
                    <tbody id="leaderboard-rows" class="text-orange-200/80">
                        <tr><td colspan="4" class="py-2 italic opacity-50 text-center">Loading Leaderboard...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- LOTTERY SECTION -->
        <div class="panel p-6 bg-black/40 mb-8 border-2 border-yellow-600">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-bold text-yellow-400">üéüÔ∏è Weekly ASDF Lottery</h3>
                <span class="text-xs font-mono bg-yellow-900/30 px-2 py-1 rounded text-yellow-300">Round #<span id="lottery-round">--</span></span>
            </div>

            <!-- NEW: Prize Pool Progress -->
            <div class="bg-gradient-to-r from-yellow-900/30 to-orange-900/30 p-4 rounded border border-yellow-600/50 mb-4">
                <div class="flex justify-between items-center mb-2">
                    <span class="text-sm font-bold text-yellow-400">üí∞ Prize Pool</span>
                    <span class="text-xs font-mono text-gray-400">Threshold: <span class="text-yellow-300">1,000,000 ASDF</span></span>
                </div>
                <div class="h-6 bg-black/50 rounded-full overflow-hidden border border-yellow-900/50 mb-2">
                    <div id="lottery-pool-bar" class="h-full bg-gradient-to-r from-yellow-500 to-orange-500 transition-all duration-500" style="width: 0%"></div>
                </div>
                <div class="flex justify-between items-center text-xs font-mono">
                    <span class="text-white"><span id="lottery-pool-amount">0</span> ASDF</span>
                    <span id="lottery-pool-percent" class="text-yellow-400">0%</span>
                </div>
                <div id="lottery-pool-status" class="text-center mt-2 text-xs font-mono text-gray-500">
                    Accumulating from platform fees...
                </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                <!-- Next Draw -->
                <div class="bg-black/30 p-4 rounded border border-yellow-900/50 text-center">
                    <span class="block text-[10px] text-yellow-500 font-mono uppercase mb-1">Next Draw</span>
                    <span id="lottery-countdown" class="text-2xl font-mono font-bold text-white">--d --h --m</span>
                </div>

                <!-- Your Tickets -->
                <div class="bg-black/30 p-4 rounded border border-yellow-900/50 text-center">
                    <span class="block text-[10px] text-yellow-500 font-mono uppercase mb-1">Your Tickets</span>
                    <span id="lottery-tickets" class="text-2xl font-mono font-bold text-yellow-400">--</span>
                    <span id="lottery-tickets-max" class="text-xs text-gray-500 block">/52 max</span>
                    <span id="lottery-activity" class="text-[10px] text-cyan-400 block mt-1">Activity: --/7 days</span>
                </div>

                <!-- Recent Winner -->
                <div class="bg-black/30 p-4 rounded border border-yellow-900/50 text-center">
                    <span class="block text-[10px] text-yellow-500 font-mono uppercase mb-1">Last Winner</span>
                    <span id="lottery-winner" class="text-lg font-mono font-bold text-green-400">--</span>
                    <span id="lottery-prize" class="text-xs text-yellow-300 block">-- ASDF</span>
                </div>
            </div>

            <!-- Eligibility Info -->
            <div id="lottery-eligibility" class="bg-yellow-900/20 p-3 rounded border border-yellow-900/30 text-xs font-mono">
                <div class="flex justify-between items-center">
                    <span class="text-yellow-400">Eligibility:</span>
                    <span id="lottery-status" class="text-gray-400">Connect wallet to check</span>
                </div>
                <div class="flex justify-between items-center mt-1 text-gray-500">
                    <span>Required: ‚â•0.00552% of supply</span>
                    <span id="lottery-threshold">-- ASDF</span>
                </div>
                <div id="lottery-holding-info" class="hidden mt-2 pt-2 border-t border-yellow-900/30">
                    <div class="flex justify-between">
                        <span class="text-yellow-400">Your Balance:</span>
                        <span id="lottery-balance" class="text-white">-- ASDF</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-yellow-400">Weeks Holding:</span>
                        <span id="lottery-weeks" class="text-white">--</span>
                    </div>
                </div>
            </div>

            <!-- How it works -->
            <div class="mt-4 text-[10px] text-gray-500 font-mono">
                <strong class="text-yellow-500">How it works:</strong> Hold ‚â•0.00552% ASDF + play daily for 7/7 days = 100% tickets. Base tickets = 1 + weeks holding (max 52). Activity multiplier = days active / 7. Organic & libertarian: no gaming, just play.
            </div>
        </div>

        <!-- REFERRAL SECTION (552 SYMMETRY) -->
        <div class="panel p-6 bg-black/40 mb-8 border-2 border-cyan-600">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-bold text-cyan-400">üîó Referral Rewards</h3>
                <span class="text-xs font-mono bg-cyan-900/30 px-2 py-1 rounded text-cyan-300">Earn ASDF</span>
            </div>

            <!-- Referral Code Section -->
            <div class="bg-gradient-to-r from-cyan-900/30 to-blue-900/30 p-4 rounded border border-cyan-600/50 mb-4">
                <div class="flex justify-between items-center mb-2">
                    <span class="text-sm font-bold text-cyan-400">üìã Your Referral Code</span>
                    <span id="referral-code-status" class="text-xs font-mono text-gray-400">Connect wallet</span>
                </div>
                <div class="flex gap-2">
                    <input type="text" id="referral-code-display" readonly
                        class="flex-1 bg-black/50 border border-cyan-900/50 rounded px-3 py-2 font-mono text-lg text-cyan-300 text-center"
                        value="--------" placeholder="--------">
                    <button onclick="window.copyReferralCode()" id="copy-code-btn"
                        class="px-4 py-2 bg-cyan-700 hover:bg-cyan-600 text-white font-bold rounded border border-cyan-500 transition-colors disabled:opacity-50 disabled:cursor-not-allowed"
                        disabled>Copy</button>
                </div>
                <div id="referral-code-message" class="text-center mt-2 text-xs font-mono text-gray-500">
                    Hold 55,200+ ASDF to create your referral code
                </div>
            </div>

            <!-- Pending Rewards -->
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                <div class="bg-black/30 p-4 rounded border border-cyan-900/50 text-center">
                    <span class="block text-[10px] text-cyan-500 font-mono uppercase mb-1">Pending Rewards</span>
                    <span id="referral-pending-asdf" class="text-2xl font-mono font-bold text-cyan-400">0</span>
                    <span class="text-xs text-gray-400 block">ASDF</span>
                </div>
                <div class="bg-black/30 p-4 rounded border border-cyan-900/50 text-center">
                    <span class="block text-[10px] text-cyan-500 font-mono uppercase mb-1">Your ASDF Balance</span>
                    <span id="referral-your-balance" class="text-2xl font-mono font-bold text-white">0</span>
                    <span class="text-xs text-gray-400 block">ASDF</span>
                </div>
                <div class="bg-black/30 p-4 rounded border border-cyan-900/50 text-center">
                    <span class="block text-[10px] text-cyan-500 font-mono uppercase mb-1">Claimable Now</span>
                    <span id="referral-claimable" class="text-2xl font-mono font-bold text-green-400">0</span>
                    <span class="text-xs text-gray-400 block">ASDF</span>
                </div>
            </div>

            <!-- Claim Button -->
            <div class="text-center mb-4">
                <button onclick="window.claimReferralRewards()" id="claim-btn"
                    class="px-8 py-3 bg-gradient-to-r from-green-700 to-cyan-700 hover:from-green-600 hover:to-cyan-600 text-white font-bold text-lg rounded-lg border-2 border-green-500 transition-all disabled:opacity-50 disabled:cursor-not-allowed disabled:from-gray-700 disabled:to-gray-700 disabled:border-gray-500"
                    disabled>
                    <span id="claim-btn-text">Claim ASDF Rewards</span>
                </button>
                <div id="claim-message" class="mt-2 text-xs font-mono text-gray-500"></div>
            </div>

            <!-- Stats Grid -->
            <div class="grid grid-cols-2 md:grid-cols-4 gap-2 mb-4 text-xs font-mono">
                <div class="bg-black/20 p-2 rounded text-center">
                    <span class="text-gray-500 block">Referred Users</span>
                    <span id="referral-users-count" class="text-cyan-400">0</span>
                </div>
                <div class="bg-black/20 p-2 rounded text-center">
                    <span class="text-gray-500 block">Volume Generated</span>
                    <span id="referral-volume" class="text-cyan-400">0 SOL</span>
                </div>
                <div class="bg-black/20 p-2 rounded text-center">
                    <span class="text-gray-500 block">Total Claimed</span>
                    <span id="referral-total-claimed" class="text-green-400">0 ASDF</span>
                </div>
                <div class="bg-black/20 p-2 rounded text-center">
                    <span class="text-gray-500 block">Referred By</span>
                    <span id="referral-referred-by" class="text-gray-400">None</span>
                </div>
            </div>

            <!-- Register with Code -->
            <div id="register-section" class="bg-cyan-900/20 p-3 rounded border border-cyan-900/30 mb-4">
                <div class="text-sm font-bold text-cyan-400 mb-2">Have a referral code?</div>
                <div class="flex gap-2">
                    <input type="text" id="register-code-input" maxlength="8"
                        class="flex-1 bg-black/50 border border-cyan-900/50 rounded px-3 py-2 font-mono text-center uppercase"
                        placeholder="ENTER CODE">
                    <button onclick="window.registerReferralCode()" id="register-btn"
                        class="px-4 py-2 bg-cyan-700 hover:bg-cyan-600 text-white font-bold rounded border border-cyan-500 transition-colors disabled:opacity-50"
                        disabled>Register</button>
                </div>
                <div id="register-message" class="mt-2 text-xs font-mono text-center"></div>
            </div>

            <!-- How it works -->
            <div class="text-[10px] text-gray-500 font-mono">
                <strong class="text-cyan-500">552 SYMMETRY:</strong>
                <span class="text-cyan-300">You earn 0.552%</span> of your bets in ASDF.
                <span class="text-blue-300">Referrer earns 0.448%</span> of your bets.
                <strong class="text-yellow-400">Flywheel:</strong> You can only claim up to your ASDF balance. Hold more = claim more!
            </div>
        </div>

        <!-- ABOUT SECTION (FULLY EXPANDED) -->
        <div class="panel p-6 bg-black/40">
            <button onclick="window.toggleAbout()" class="w-full text-left flex justify-between items-center text-orange-400 hover:text-white transition-colors"><span class="font-bold text-lg font-mono">>> METHODOLOGY & MECHANICS</span><span id="about-icon">[ + ]</span></button>
            <div id="about-content" class="hidden mt-4 text-sm text-orange-200/80 font-mono space-y-6 border-t border-orange-900/50 pt-4">
                <div><strong class="text-white block mb-1 text-base border-l-4 border-orange-500 pl-2">1. OBJECTIVE</strong><p class="leading-relaxed">The room is on fire. The price of Solana is moving. Predict if the candle will close <strong>HIGHER (This is Fine)</strong> or <strong>LOWER (It Burns)</strong> relative to the start of the 15-minute frame. Frames are aligned to the blockchain timestamp and operate in a continuous 15-minute cycle. The "Open Price" is locked exactly at the start of the frame, and the "Close Price" is determined at the moment the frame ends.</p></div>
                <div><strong class="text-white block mb-1 text-base border-l-4 border-orange-500 pl-2">2. MECHANICS</strong><p class="mb-2 leading-relaxed">This is a peer-to-peer parimutuel market. There is no "House" taking the other side of your bet; you are betting against other users. Winners divide the losers' money proportionally.</p><ul class="list-disc list-inside ml-2 space-y-2 text-orange-100/80"><li><strong>Shares:</strong> You buy "Shares" of a direction (UP or DOWN). One Share represents a claim on a portion of the final pot.</li><li><strong>Dynamic Pricing:</strong> The cost of 1 Share is not fixed. It fluctuates based on the ratio of money in the UP pool vs the DOWN pool. If 90% of the money is on UP, UP shares are expensive (low reward), and DOWN shares are cheap (high reward).</li><li><strong>No Odds Until Close:</strong> Unlike fixed-odds betting, your final payout multiplier is determined by the pool state at the moment the frame closes.</li></ul></div>
                <div><strong class="text-white block mb-1 text-base border-l-4 border-orange-500 pl-2">3. PRICING FORMULA</strong><p class="mb-2">The system maintains a constant invariant: <code>Price(UP) + Price(DOWN) = 0.1 SOL</code>.</p><div class="bg-black/50 p-3 rounded border border-orange-900/50 font-mono text-xs text-green-400">Share Price = (Liquidity_In_Direction / Total_Liquidity) * 0.1</div><p class="mt-2 text-xs text-gray-500">Note: A small virtual liquidity buffer (50 shares) is applied to both sides at the start of a frame to prevent infinite price swings on the very first bet.</p></div>
                <div><strong class="text-white block mb-1 text-base border-l-4 border-orange-500 pl-2">4. PAYOUTS & FEES</strong><ul class="list-disc list-inside ml-2 space-y-2 text-orange-100/80 text-xs"><li><strong>THE ASH PILE (FEES):</strong> 5.52% of the Total Volume (all wagers combined) is deducted automatically. This revenue is sent to the Fee Wallet to buy back and burn <strong>$ASDFASDFA</strong>.</li><li><strong>House Reserve:</strong> 0.48% is retained to cover Solana network rent and transaction gas fees.</li><li><strong>The Winner's Pot:</strong> The remaining 94% of the Total Volume is the pot.</li><li><strong>Distribution:</strong> the pot is then distributed to winners divided among them based on how many shares they own, proportional to the total amount of winning shares.</li><li class="text-red-400"><strong>TOTAL MELTDOWN (FLAT MARKET):</strong> If the Open Price and Close Price are identical (0.00% Change), nobody wins. The house burns down. 99% of the pot is sent to the incinerator (Fee Wallet).</li><li class="text-red-400"><strong>THE HEDGE PARADOX:</strong> If you hold an exact equal amount of UP and DOWN shares (a flat position), you have signaled no conviction. The system treats this as a LOSS, regardless of the outcome. You will receive 0 payout.</li></ul></div>
                <div><strong class="text-white block mb-1 text-base border-l-4 border-orange-500 pl-2">5. SCENARIOS</strong><div class="space-y-3 text-xs mt-2"><div class="bg-black/30 p-3 rounded border-l-2 border-green-500"><span class="text-green-400 font-bold block mb-1">Scenario A: The Crowd Follower (Consensus)</span><p class="opacity-80"><strong>The Situation:</strong> The market is bullish. 90 SOL is on UP, 10 SOL is on DOWN.<br><strong>Your Bet:</strong> You bet 1 SOL on UP.<br><strong>The Outcome:</strong> UP Wins.<br><strong>The Math:</strong> The Pot is ~94 SOL. You own roughly 1.1% of the winning pool.<br><strong>Result:</strong> You receive ~1.04 SOL back. A small, safe 4% profit.</p></div><div class="bg-black/30 p-3 rounded border-l-2 border-yellow-500"><span class="text-yellow-400 font-bold block mb-1">Scenario B: The Contrarian (Longshot)</span><p class="opacity-80"><strong>The Situation:</strong> The market is bullish (90 SOL UP vs 10 SOL DOWN).<br><strong>Your Bet:</strong> You bet 1 SOL on DOWN (The Underdog).<br><strong>The Outcome:</strong> DOWN Wins.<br><strong>The Math:</strong> The Pot is ~94 SOL. You own roughly 10% of the winning pool (since the pool is small).<br><strong>Result:</strong> You receive ~9.40 SOL back. A massive 840% profit for betting against the crowd.</p></div></div></div>
                <div class="mt-6 border-t-2 border-red-900/50 pt-4 bg-red-900/10 p-4 rounded"><strong class="text-red-500 block mb-1 text-lg">‚ö†Ô∏è DISCLAIMER & RISK WARNING</strong><p class="text-xs text-orange-200 leading-relaxed">This platform is currently LIVE on Solana Mainnet. The operators are not responsible for lost funds, smart contract errors, oracle latency, or network failures. <br><br><strong>PREDICT RESPONSIBLY:</strong> Never wager funds you cannot afford to lose. This is an experimental technology demonstration.</p></div>
            </div>
        </div>
        <div class="text-center text-xs text-gray-500 font-mono pt-2 border-t border-orange-900/50"><span class="text-orange-400">Frontend v126.5</span> | Backend <span id="backend-version">v---</span></div>
    </div>

    <!-- SHARE MODAL -->
    <div id="share-modal" class="fixed inset-0 z-50 hidden flex items-center justify-center bg-black/60" onclick="if(event.target === this) this.classList.add('hidden')">
        <div class="share-card relative" onclick="event.stopPropagation()">
            <button onclick="document.getElementById('share-modal').classList.add('hidden')" class="absolute top-2 right-3 text-gray-400 hover:text-white">‚úï</button>
            <h2 class="text-xl font-bold text-orange-500 mb-4">FLEX YOUR DEGEN STATS</h2>
            <img id="share-preview" src="" alt="Stats Card">
            <div class="flex gap-2 mt-4">
                <button onclick="downloadShareImage()" class="flex-1 bg-orange-600 text-white py-3 rounded font-bold hover:bg-orange-500 shadow-lg">DOWNLOAD üíæ</button>
                <button onclick="shareToTwitter()" class="flex-1 bg-black border border-white text-white py-3 rounded font-bold hover:bg-gray-900 shadow-lg">POST TO ùïè</button>
            </div>
        </div>
    </div>

    <!-- HISTORY MODAL -->
    <div id="history-modal" class="fixed inset-0 z-50 hidden flex items-center justify-center bg-black/80 backdrop-blur-sm" onclick="if(event.target === this) this.classList.add('hidden')">
        <div class="history-card flex flex-col" onclick="event.stopPropagation()">
            <div class="p-4 border-b border-orange-900/50 flex justify-between items-center bg-[#1d120e]">
                <div>
                    <h2 class="text-xl font-bold text-white">FRAME HISTORY</h2>
                    <p class="text-[10px] text-orange-400/70 font-mono">Last 50 Frames</p>
                </div>
                <div class="flex items-center gap-4">
                     <input type="text" id="public-history-search" placeholder="Search ID or Result..." class="bg-black text-white text-xs p-2 rounded border border-gray-700 w-48" onkeyup="filterPublicHistory()">
                     <button onclick="document.getElementById('history-modal').classList.add('hidden')" class="text-gray-400 hover:text-white text-2xl font-bold">‚úï</button>
                </div>
            </div>
            
            <div class="flex-grow overflow-y-auto custom-scroll p-4 bg-black/20">
                <table class="w-full text-xs font-mono text-left">
                    <thead class="text-orange-500 border-b border-orange-900/50 sticky top-0 bg-[#1d120e] shadow-lg">
                        <tr>
                            <th class="pb-3 pl-2">Time (Close)</th>
                            <th class="pb-3">ID</th>
                            <th class="pb-3">Result</th>
                            <th class="pb-3 text-right">Open</th>
                            <th class="pb-3 text-right">Close</th>
                            <th class="pb-3 text-right">Vol (SOL)</th>
                            <th class="pb-3 text-right">Fee (SOL)</th>
                            <th class="pb-3 text-right">Users</th>
                            <th class="pb-3 text-right pr-2">Payout (SOL)</th>
                        </tr>
                    </thead>
                    <tbody id="public-history-rows" class="text-orange-200/80 divide-y divide-orange-900/20">
                        </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<script>
    const HOUSE_PUBKEY = "BXSp5y6Ua6tB5fZDe1EscVaaEaZLg1yqzrsPqAXhKJYy"; // MAINNET WALLET
    const IS_LOCAL = ['localhost', '127.0.0.1'].includes(window.location.hostname) || window.location.hostname.includes('github.dev');
    const API_URL = IS_LOCAL
        ? (window.location.hostname.includes('github.dev')
            ? window.location.origin.replace('-8080.', '-3000.') + '/api'
            : 'http://localhost:3000/api')
        : 'https://asdforecast.onrender.com/api'; 
    // SECURITY NOTE: This key is visible to the client. Restrict origin in Helius Dashboard!
    const HELIUS_RPC_URL = "https://mainnet.helius-rpc.com/?api-key=3ce79dab-c031-4ebe-a060-edc91bf0edee";
    
    let PublicKey, SystemProgram, Transaction;
    let state = { pubKey: null, prices: { up: 0.05, down: 0.05 }, conn: null, fullHistory: [], lastFrameId: null, userLog: {}, isHistoryExpanded: false, isAboutExpanded: false, isOnline: false, targetEndTime: null, isResetting: false, isCancelled: false, baseImageSrc: null, images: { fine: null, over: null, sentUp: null, sentDown: null }, solBalance: 0 };
    let ui = {};
    let pollTimeout = null; // Store market data timeout ID for cleanup
    let balanceIntervalId = null; // NEW: Store balance interval ID

    // WebSocket for real-time updates
    let ws = null;
    let wsReconnectAttempts = 0;
    const WS_RECONNECT_MAX_DELAY = 30000; // 30s max backoff

    window.addEventListener('load', () => {
        if (window.solanaWeb3) {
            PublicKey = solanaWeb3.PublicKey;
            SystemProgram = solanaWeb3.SystemProgram;
            Transaction = solanaWeb3.Transaction;
            
            // FIXED: Use Helius RPC for the browser connection to bypass 403 errors
            state.conn = new solanaWeb3.Connection(HELIUS_RPC_URL, {
                commitment: 'confirmed',
                confirmTransactionInitialTimeout: 60000
            });
        }
        
        ui = {
            price: document.getElementById('price'), change: document.getElementById('change'), timer: document.getElementById('timer'),
            frameStart: document.getElementById('frame-start'), frameEnd: document.getElementById('frame-end'),
            barUp: document.getElementById('bar-up'), barDown: document.getElementById('bar-down'),
            lblSharesUp: document.getElementById('lbl-shares-up'), lblSharesDown: document.getElementById('lbl-shares-down'),
            lblPriceUp: document.getElementById('lbl-price-up'), lblPriceDown: document.getElementById('lbl-price-down'),
            up1m: document.getElementById('up-1m'), up5m: document.getElementById('up-5m'), down1m: document.getElementById('down-1m'), down5m: document.getElementById('down-5m'),
            currentPot: document.getElementById('current-pot'), qty: document.getElementById('qty-input'),
            costUp: document.getElementById('cost-up'), costDown: document.getElementById('cost-down'),
            bal: document.getElementById('balance'), form: document.getElementById('order-form'),
            connect: document.getElementById('connect-btn'), disconnect: document.getElementById('disconnect-btn'),
            historyRows: document.getElementById('history-rows'), historyContainer: document.getElementById('history-container'),
            statsContainer: document.getElementById('user-stats-container'), statWin: document.getElementById('stat-winrate'), statVol: document.getElementById('stat-volume'),
            statActUp: document.getElementById('stat-active-up'), statActDown: document.getElementById('stat-active-down'),
            statActUpSol: document.getElementById('stat-active-up-sol'), // ADDED
            statActDownSol: document.getElementById('stat-active-down-sol'), // ADDED
            statPayout: document.getElementById('stat-payout'), 
            
            // UPDATE: Mapped to the new ID
            lastFrameStats: document.getElementById('last-frame-data'),
            
            // RESTORED IDs
            statGlobalVol: document.getElementById('global-vol'), 
            statGlobalFees: document.getElementById('global-fees'), 
            statGlobalASDF: document.getElementById('global-asdf'),
            
            topStatus: document.getElementById('top-status-indicator'), ticker: document.getElementById('ticker-content'),
            lastUpdated: document.getElementById('last-updated'), netSharesHeader: document.getElementById('net-shares-header'),
            btnUp: document.getElementById('btn-buy-up'), btnDown: document.getElementById('btn-buy-down'),
            btnInc: document.getElementById('btn-inc'), btnDec: document.getElementById('btn-dec'),
            pauseOverlay: document.getElementById('pause-overlay'), statusText: document.getElementById('status-text'),
            backendVersion: document.getElementById('backend-version'), statusDot: document.getElementById('status-dot'),
            pauseText: document.querySelector('#pause-overlay span:nth-child(2)'),
            leaderboardRows: document.getElementById('leaderboard-rows'),
            
            // NEW UI ELEMENTS
            frameUsers: document.getElementById('frame-users'),
            globalLastPayout: document.getElementById('link-last-payout'), 
            globalWinnings: document.getElementById('global-winnings'),
            globalLifetimeUsers: document.getElementById('global-lifetime-users'),

            // LOTTERY UI ELEMENTS
            lotteryRound: document.getElementById('lottery-round'),
            lotteryCountdown: document.getElementById('lottery-countdown'),
            lotteryTickets: document.getElementById('lottery-tickets'),
            lotteryActivity: document.getElementById('lottery-activity'),
            lotteryWinner: document.getElementById('lottery-winner'),
            lotteryPrize: document.getElementById('lottery-prize'),
            lotteryStatus: document.getElementById('lottery-status'),
            lotteryThreshold: document.getElementById('lottery-threshold'),
            lotteryHoldingInfo: document.getElementById('lottery-holding-info'),
            lotteryBalance: document.getElementById('lottery-balance'),
            lotteryWeeks: document.getElementById('lottery-weeks'),
            // NEW: Prize Pool UI
            lotteryPoolBar: document.getElementById('lottery-pool-bar'),
            lotteryPoolAmount: document.getElementById('lottery-pool-amount'),
            lotteryPoolPercent: document.getElementById('lottery-pool-percent'),
            lotteryPoolStatus: document.getElementById('lottery-pool-status'),
            // SENTIMENT UI ELEMENTS
            broadcastContainer: document.getElementById('admin-broadcast-container'),
            broadcastText: document.getElementById('broadcast-text'),
            sentTimer: document.getElementById('sent-timer'),
            sentBarFill: document.getElementById('sent-bar-fill'),
            valSentUp: document.getElementById('val-sent-up'),
            valSentDown: document.getElementById('val-sent-down'),
            btnSentUp: document.getElementById('btn-sent-up'),
            btnSentDown: document.getElementById('btn-sent-down'),
            // PUBLIC HISTORY MODAL
            publicHistoryRows: document.getElementById('public-history-rows'),
            publicHistorySearch: document.getElementById('public-history-search'),
            // SENTIMENT IMAGES
            imgSentUp: document.getElementById('img-sent-up'),
            imgSentDown: document.getElementById('img-sent-down'),
            sentTimer: document.getElementById('sent-timer'),
            // ABOUT TOGGLE
            aboutContent: document.getElementById('about-content'),
            aboutIcon: document.getElementById('about-icon'),
            // REFERRAL UI ELEMENTS
            referralCodeDisplay: document.getElementById('referral-code-display'),
            referralCodeStatus: document.getElementById('referral-code-status'),
            referralCodeMessage: document.getElementById('referral-code-message'),
            copyCodeBtn: document.getElementById('copy-code-btn'),
            referralPendingAsdf: document.getElementById('referral-pending-asdf'),
            referralYourBalance: document.getElementById('referral-your-balance'),
            referralClaimable: document.getElementById('referral-claimable'),
            claimBtn: document.getElementById('claim-btn'),
            claimBtnText: document.getElementById('claim-btn-text'),
            claimMessage: document.getElementById('claim-message'),
            referralUsersCount: document.getElementById('referral-users-count'),
            referralVolume: document.getElementById('referral-volume'),
            referralTotalClaimed: document.getElementById('referral-total-claimed'),
            referralReferredBy: document.getElementById('referral-referred-by'),
            registerSection: document.getElementById('register-section'),
            registerCodeInput: document.getElementById('register-code-input'),
            registerBtn: document.getElementById('register-btn'),
            registerMessage: document.getElementById('register-message')
        };

        if(ui.btnInc) ui.btnInc.onclick = () => adjustQty(1);
        if(ui.btnDec) ui.btnDec.onclick = () => adjustQty(-1);

        ui.connect.onclick = connect;
        ui.disconnect.onclick = disconnectWallet;
        // Call updateCosts when quantity changes
        ui.qty.oninput = () => { ui.qty.value = Math.floor(Math.max(1, ui.qty.value)); updateCosts(); };

        // Fetch Images immediately
        fetch(`${API_URL}/api/image/fine`).then(r=>r.json()).then(d=>{ if(d.image) state.images.fine = d.image; });
        fetch(`${API_URL}/api/image/over`).then(r=>r.json()).then(d=>{ if(d.image) state.images.over = d.image; });
        fetch(`${API_URL}/api/image/sentiment-up`).then(r=>r.json()).then(d=>{ if(d.image && ui.imgSentUp) { ui.imgSentUp.src = d.image; state.images.sentUp = d.image; } });
        fetch(`${API_URL}/api/image/sentiment-down`).then(r=>r.json()).then(d=>{ if(d.image && ui.imgSentDown) { ui.imgSentDown.src = d.image; state.images.sentDown = d.image; } });

        // PAGE VISIBILITY OPTIMIZATION
        document.addEventListener("visibilitychange", () => {
            if (document.hidden) {
                if (pollTimeout) { clearTimeout(pollTimeout); pollTimeout = null; }
                if (balanceIntervalId) { clearInterval(balanceIntervalId); balanceIntervalId = null; } // NEW: Stop balance check
            } else {
                poll(); // Immediate update on wake
                if (state.pubKey && !balanceIntervalId) startBalancePolling(); // NEW: Restart balance check if connected
            }
        });

        // ESCAPE KEY TO CLOSE MODALS
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                document.getElementById('history-modal')?.classList.add('hidden');
                document.getElementById('share-modal')?.classList.add('hidden');
            }
        });

        // Start polling initially
        poll();
        // Initialize WebSocket for real-time updates
        initWebSocket();
        setInterval(updateTimer, 1000);
        setTimeout(() => { if(window.solana?.isPhantom) window.solana.connect({onlyIfTrusted:true}).then(onConnect).catch(()=>{}); }, 500);
    });
    
    // NEW: Function to start periodic balance checks
    function startBalancePolling() {
        if (!state.pubKey) return;
        if (balanceIntervalId) clearInterval(balanceIntervalId);
        // Start polling immediately and then every 20 seconds
        refreshBalance(); 
        balanceIntervalId = setInterval(refreshBalance, 20000); 
    }

    // NEW: Function to stop periodic balance checks
    function stopBalancePolling() {
        if (balanceIntervalId) {
            clearInterval(balanceIntervalId);
            balanceIntervalId = null;
        }
    }

    // NEW: Sentiment Vote Logic with PubKey Validation
    window.voteSentiment = async function(dir) {
        if (!state.pubKey) {
            alert("Please connect your wallet to vote.");
            return;
        }

        const btn = dir === 'UP' ? ui.btnSentUp : ui.btnSentDown;
        btn.disabled = true; // Immediate visual feedback
        
        try {
            const res = await fetch(`${API_URL}/sentiment/vote`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ direction: dir, userPubKey: state.pubKey.toString() })
            });
            const data = await res.json();
            if (data.error === "VOTE_COOLDOWN") {
                alert("Cooldown active: You can only vote once per hour.");
            } else if (data.error === "IP_COOLDOWN_ACTIVE") {
                alert("Cooldown active: Too many votes from this location. Please try again later.");
            } else if (!data.success) {
                alert("Vote failed: " + (data.error || "Unknown error"));
            }
        } catch(e) { console.error(e); }
        
        // Keep disabled for 15s visually (backend enforces 1h)
        setTimeout(() => { btn.disabled = false; }, 15000);
    };

    function updateTimer() {
        if (state.isResetting) { if(ui.timer) ui.timer.innerText = "Resetting..."; return; }
        // LOCAL LOCKDOWN CHECK
        if (state.targetEndTime && state.targetEndTime <= Date.now() + 500) { if(ui.timer) ui.timer.innerText = "Calculating..."; return; }
        if (!state.targetEndTime) return;
        const now = Date.now();
        let diff = state.targetEndTime - now;
        if (diff < 0) diff = 0;
        const m = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
        const s = Math.floor((diff % (1000 * 60)) / 1000);
        if(ui.timer) ui.timer.innerText = `${m}:${s.toString().padStart(2, '0')}`;
    }

    function formatChange(el, val) { if (!val) val = 0; const sign = val >= 0 ? '+' : ''; const color = val > 0 ? 'text-green-400' : (val < 0 ? 'text-red-400' : 'text-gray-400'); el.innerHTML = `<span class="${color}">${sign}${val.toFixed(2)}%</span>`; }
    
    // NEW: OPEN HISTORY MODAL
    window.openHistoryModal = function() {
        if (!state.fullHistory || state.fullHistory.length === 0) {
            alert("No history data available yet.");
            return;
        }
        // Take last 50
        const recentHistory = state.fullHistory.slice(0, 50);
        renderPublicHistory(recentHistory);
        document.getElementById('history-modal').classList.remove('hidden');
    };

    function renderPublicHistory(data) {
        ui.publicHistoryRows.innerHTML = data.map(f => {
            const timeVal = f.endTime || f.time;
            const time = new Date(timeVal).toLocaleString();
            let resColor = 'text-gray-400';
            if (f.result === 'UP') resColor = 'text-green-400 font-bold';
            if (f.result === 'DOWN') resColor = 'text-red-400 font-bold';
            if (f.result === 'CANCELLED') resColor = 'text-red-600 font-bold';

            return `
                <tr class="hover:bg-white/5 border-b border-orange-900/20">
                    <td class="py-3 pl-2 whitespace-nowrap">${time}</td>
                    <td class="py-3 text-xs text-gray-500 font-mono">${f.id}</td>
                    <td class="py-3 ${resColor}">${f.result}</td>
                    <td class="py-3 text-right text-gray-400">$${(f.open||0).toFixed(2)}</td>
                    <td class="py-3 text-right text-gray-400">$${(f.close||0).toFixed(2)}</td>
                    <td class="py-3 text-right font-bold text-white">${(f.totalSol||0).toFixed(2)}</td>
                    <td class="py-3 text-right text-red-400/70">${(f.fee||0).toFixed(3)}</td>
                    <td class="py-3 text-right text-blue-300">${f.users||0}</td>
                    <td class="py-3 text-right pr-2 text-green-400 font-bold">${(f.payout||0).toFixed(2)}</td>
                </tr>
            `;
        }).join('');
    }

    window.filterPublicHistory = function() {
        const term = ui.publicHistorySearch.value.toLowerCase();
        // Filter from the global state history, sliced to 50
        const sourceData = state.fullHistory.slice(0, 50);
        const filtered = sourceData.filter(f => 
            f.id.toString().includes(term) || 
            f.result.toLowerCase().includes(term)
        );
        renderPublicHistory(filtered);
    };

    window.toggleAbout = function() {
        state.isAboutExpanded = !state.isAboutExpanded;
        if (state.isAboutExpanded) {
            ui.aboutContent.classList.remove('hidden');
            ui.aboutIcon.innerText = "[ - ]";
        } else {
            ui.aboutContent.classList.add('hidden');
            ui.aboutIcon.innerText = "[ + ]";
        }
    };

    async function connect() { try { await window.solana.connect(); onConnect(await window.solana.connect()); } catch(e){} }
    async function disconnectWallet() {
        if(window.solana) await window.solana.disconnect();
        stopBalancePolling();
        state.pubKey = null;
        state.solBalance = 0;
        state.userLog = {};
        ui.connect.innerText = "Connect Phantom";
        ui.form.classList.add('opacity-50', 'pointer-events-none');
        ui.disconnect.classList.add('hidden');
        ui.bal.innerText = "0.0000";
        ui.statsContainer.classList.add('hidden');
        renderHistory();
        updateCosts();
        if(lotteryEligibilityInterval) { clearInterval(lotteryEligibilityInterval); lotteryEligibilityInterval = null; }
        if(referralStatsInterval) { clearInterval(referralStatsInterval); referralStatsInterval = null; }
        fetchLotteryEligibility();
        fetchReferralStats();
    }
    function onConnect(resp) {
        state.pubKey = resp.publicKey;
        ui.connect.innerText = `üë§ ${resp.publicKey.toString().slice(0,4)}...`;
        ui.form.classList.remove('opacity-50', 'pointer-events-none');
        ui.disconnect.classList.remove('hidden');
        startBalancePolling();
        poll();
        startLotteryEligibilityPolling();
        startReferralPolling();
        // Authenticate WebSocket with new pubKey
        if (ws && ws.readyState === WebSocket.OPEN) {
            ws.send(JSON.stringify({ type: 'AUTH', pubKey: resp.publicKey.toString() }));
        }
    }
    async function refreshBalance() {
        if(state.pubKey) {
            try {
                const bal = await state.conn.getBalance(state.pubKey);
                state.solBalance = bal / 1e9;
                ui.bal.innerText = state.solBalance.toFixed(4);
                updateCosts();
            } catch (e) {
                console.error("Failed to refresh balance:", e);
                updateCosts();
            }
        }
    }
    function adjustQty(n) {
        if(ui.qty.disabled) {
            alert("Cannot adjust quantity while market is paused or calculating results.");
            return;
        }
        let v = parseInt(ui.qty.value) + n;
        if(v < 1) v = 1;
        ui.qty.value = Math.floor(v);
        updateCosts();
    }
    function updateCosts() {
        const q = parseInt(ui.qty.value) || 0;
        if(state.prices.up && ui.costUp) {
            const costUp = q * state.prices.up;
            const costDown = q * state.prices.down;
            ui.costUp.innerText = costUp.toFixed(3) + " SOL";
            ui.costDown.innerText = costDown.toFixed(3) + " SOL";
            const isMarketBlocking = state.isResetting || state.isCancelled || state.isPaused || (state.targetEndTime && state.targetEndTime <= Date.now() + 500);
            const isConnected = !!state.pubKey;
            ui.qty.disabled = isMarketBlocking || !isConnected;
            ui.btnInc.disabled = isMarketBlocking || !isConnected;
            ui.btnDec.disabled = isMarketBlocking || !isConnected;
            const hasUpFunds = costUp <= state.solBalance;
            const hasDownFunds = costDown <= state.solBalance;
            ui.btnUp.disabled = isMarketBlocking || !hasUpFunds || !isConnected;
            ui.btnDown.disabled = isMarketBlocking || !hasDownFunds || !isConnected;
            if (!hasUpFunds) { ui.costUp.classList.add('text-red-500'); ui.costUp.classList.remove('text-green-300'); }
            else { ui.costUp.classList.remove('text-red-500'); ui.costUp.classList.add('text-green-300'); }
            if (!hasDownFunds) { ui.costDown.classList.add('text-red-500'); ui.costDown.classList.remove('text-red-300'); }
            else { ui.costDown.classList.remove('text-red-500'); ui.costDown.classList.add('text-red-300'); }
        }
    }

    // --- SHARE STATS LOGIC (UPDATED) ---
    window.openShareModal = async function() {
        if (!state.baseImageSrc) { try { const res = await fetch(`${API_URL}/share-image`); const d = await res.json(); state.baseImageSrc = d.image; } catch(e) {} }

        const canvas = document.createElement('canvas'); canvas.width = 800; canvas.height = 400; const ctx = canvas.getContext('2d');
        
        const drawContent = () => {
             if (!state.baseImageSrc) { const grd = ctx.createLinearGradient(0, 0, 0, 400); grd.addColorStop(0, "#451a03"); grd.addColorStop(1, "#ea580c"); ctx.fillStyle = grd; ctx.fillRect(0, 0, 800, 400); }
             ctx.strokeStyle = 'black'; ctx.lineWidth = 6; ctx.font = "bold 40px sans-serif"; ctx.fillStyle = "white"; ctx.strokeText("ASDForecast", 40, 60); ctx.fillText("ASDForecast", 40, 60);
             ctx.font = "20px sans-serif"; ctx.fillStyle = "#fb923c"; ctx.strokeText("15m Binary Prediction Market", 40, 90); ctx.fillText("15m Binary Prediction Market", 40, 90);
             if (state.pubKey) { ctx.textAlign = "right"; ctx.lineWidth = 4; ctx.strokeStyle = 'black'; ctx.font = "bold 32px sans-serif"; const txt = state.pubKey.toString().slice(0, 5) + "..."; ctx.strokeText(txt, 760, 60); ctx.fillStyle = "white"; ctx.fillText(txt, 760, 60); ctx.textAlign = "left"; }
             if (state.userLog) {
                 const wins = parseInt(document.getElementById('stat-winrate').innerText.split('(')[1]) || 0;
                 const total = parseInt(document.getElementById('stat-winrate').innerText.split('/')[1]) || 0;
                 const rate = document.getElementById('stat-winrate').innerText.split('%')[0] + "%";
                 const vol = document.getElementById('stat-volume').innerText;
                 let totalWon = 0; Object.values(state.userLog).forEach(f => { if(f.payoutAmount) totalWon += f.payoutAmount; });
                 ctx.fillStyle = "rgba(0,0,0,0.6)"; ctx.fillRect(40, 120, 720, 240); ctx.fillStyle = "#fff"; ctx.font = "bold 30px sans-serif"; ctx.lineWidth = 4;
                 ctx.strokeText(`WIN RATE: ${rate}`, 80, 180); ctx.fillText(`WIN RATE: ${rate}`, 80, 180);
                 ctx.strokeText(`W/L:      ${wins}/${total-wins}`, 80, 230); ctx.fillText(`W/L:      ${wins}/${total-wins}`, 80, 230);
                 ctx.strokeText(`VOLUME:   ${vol}`, 80, 280); ctx.fillText(`VOLUME:   ${vol}`, 80, 280);
                 ctx.fillStyle = "#4ade80"; ctx.strokeText(`WON:      ${totalWon.toFixed(2)} SOL`, 80, 330); ctx.fillText(`WON:      ${totalWon.toFixed(2)} SOL`, 80, 330);
             }
             ctx.font = "bold 24px sans-serif"; ctx.lineWidth = 4; ctx.strokeStyle = "black"; ctx.fillStyle = "white";
             ctx.textAlign = "right"; ctx.strokeText("alonisthe.dev", 760, 380); ctx.fillText("alonisthe.dev", 760, 380);
             ctx.textAlign = "left"; ctx.strokeText("$ASDFASDFA", 40, 380); ctx.fillText("$ASDFASDFA", 40, 380);
             document.getElementById('share-preview').src = canvas.toDataURL('image/png'); document.getElementById('share-modal').classList.remove('hidden');
        };

        if (state.baseImageSrc) { const img = new Image(); img.onload = () => { ctx.drawImage(img, 0, 0, 800, 400); drawContent(); }; img.onerror = () => drawContent(); img.src = state.baseImageSrc; } else { drawContent(); }
    };

    window.downloadShareImage = function() {
        const link = document.createElement('a'); link.download = 'ASDForecast_Stats.png'; link.href = document.getElementById('share-preview').src; link.click();
    };

    window.shareToTwitter = function() {
        downloadShareImage(); alert("Image downloaded! Attach it to your tweet in the new window."); const rate = state.userLog ? document.getElementById('stat-winrate').innerText.split('%')[0] + "%" : "0%"; 
        const text = encodeURIComponent(`I'm trading on ASDForecast.\n\nüî• Win Rate: ${rate}\n\nCan you beat my stats?`); const url = encodeURIComponent("https://www.alonisthe.dev/asdforecast"); window.open(`https://twitter.com/intent/tweet?text=${text}&url=${url}`, '_blank'); 
    };

    function renderHistory() {
        if (!state.fullHistory || state.fullHistory.length === 0) { ui.historyRows.innerHTML = '<tr><td colspan="6" class="py-2 italic opacity-50">Waiting for first frame close...</td></tr>'; return; }
        const now = Date.now(); const validHistory = state.fullHistory.filter(f => (f.endTime || 0) <= now); const dataToShow = state.isHistoryExpanded ? validHistory.slice(0, 50) : validHistory.slice(0, 3);

        ui.historyRows.innerHTML = dataToShow.map(f => {
            // MODIFIED: Use endTime for display time if available, fallback to start time
            const timeVal = f.endTime ? f.endTime : f.time;
            const time = new Date(timeVal).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});
            
            let resColor = f.result==='UP'?'text-green-400':(f.result==='DOWN'?'text-red-400':(f.result==='CANCELLED'?'text-red-600 font-bold':(f.result==='PAUSED'?'text-yellow-500 font-bold':'text-gray-400')));
            let userStatus = '<span class="text-gray-600">-</span>';
            
            if (f.result === 'PAUSED') {
                 userStatus = `<span class="text-yellow-500">SKIPPED</span>`;
            } else if (f.result === 'CANCELLED') {
                 if (state.userLog && state.userLog[f.id]) userStatus = `<span class="text-yellow-400 font-bold">REFUNDED</span>`;
            } else if (state.userLog && state.userLog[f.id]) {
                const log = state.userLog[f.id];
                if (log.result === 'LOSS') userStatus = `<span class="text-red-500 font-bold">LOSS (${(log.wagered||0).toFixed(3)})</span>`;
                // UPDATE: Handle REFUNDED_ERROR status from backend
                else if (log.result === 'REFUNDED_ERROR') userStatus = `<span class="text-yellow-500 font-bold">‚ö†Ô∏è ERR: REFUNDED</span>`;
                else if (log.payoutTx) userStatus = `<a href="https://solscan.io/tx/${log.payoutTx}" target="_blank" class="text-green-400 underline">WIN (+${log.payoutAmount?.toFixed(3)})</a>`;
                else if (log.result === 'WIN') userStatus = `<span class="text-green-600">WIN (Processing)</span>`;
            }
            return `<tr class="border-b border-orange-900/20"><td class="py-2">${time}</td><td class="py-2 font-bold ${resColor}">${f.result}</td><td class="py-2">$${(f.open||0).toFixed(2)}</td><td class="py-2">$${(f.close||0).toFixed(2)}</td><td class="py-2">${(f.totalSol||0).toFixed(2)}</td><td class="py-2">${userStatus}</td></tr>`;
        }).join('');
        //REMOVED DUE TO A BUG. Suspect this hid the Expand section previously, no longer an issue. if(state.fullHistory.length > 3) ui.btnExpand.classList.remove('hidden');
    }

    function renderTicker(trades) {
        if(!trades || !ui.ticker) return;
        ui.ticker.innerHTML = trades.slice(0,10).map(t => `<div class="ticker-item">[ ${t.user.slice(0,4)}.. bought <span class="${t.direction==='UP'?'text-green-400':'text-red-400'}">${t.shares.toFixed(1)} ${t.direction}</span> ]</div>`).join('');
    }

    function renderLeaderboard(data) {
        if (!data || data.length === 0) { ui.leaderboardRows.innerHTML = '<tr><td colspan="4" class="py-2 italic opacity-50 text-center">No Degens Yet</td></tr>'; return; }
        ui.leaderboardRows.innerHTML = data.map((user, index) => `
            <tr class="border-b border-orange-900/20">
                <td class="py-2 text-white font-bold"><span class="text-orange-500 mr-2">#${index+1}</span> ${user.pubKey.slice(0,5)}...</td>
                <td class="py-2 text-right text-gray-300">${user.bets}</td>
                <td class="py-2 text-right text-yellow-400">${user.winRate.toFixed(0)}%</td>
                <td class="py-2 text-right text-green-400 font-bold">${user.totalWon.toFixed(2)} SOL</td>
            </tr>
        `).join('');
    }

    // --- LOTTERY FUNCTIONS ---
    function formatLotteryCountdown(ms) {
        if (ms <= 0) return "Drawing...";
        const days = Math.floor(ms / (24 * 60 * 60 * 1000));
        const hours = Math.floor((ms % (24 * 60 * 60 * 1000)) / (60 * 60 * 1000));
        const mins = Math.floor((ms % (60 * 60 * 1000)) / (60 * 1000));
        if (days > 0) return `${days}d ${hours}h ${mins}m`;
        if (hours > 0) return `${hours}h ${mins}m`;
        return `${mins}m`;
    }

    function updateLotteryUI(lotteryData) {
        if (!lotteryData || !ui.lotteryRound) return;

        // Update round and countdown from cached state data
        ui.lotteryRound.innerText = lotteryData.currentRound || '--';

        // Update countdown based on threshold status
        if (lotteryData.isThresholdReached) {
            ui.lotteryCountdown.innerText = formatLotteryCountdown(lotteryData.msUntilDraw || 0);
        } else {
            ui.lotteryCountdown.innerText = 'Waiting for pool...';
            ui.lotteryCountdown.classList.add('text-gray-500');
        }

        // Update recent winner
        if (lotteryData.recentWinner) {
            ui.lotteryWinner.innerText = lotteryData.recentWinner.slice(0, 6) + '...';
            ui.lotteryPrize.innerText = (lotteryData.recentPrize || 0).toLocaleString() + ' ASDF';
        } else {
            ui.lotteryWinner.innerText = 'No draws yet';
            ui.lotteryPrize.innerText = '--';
        }

        // NEW: Update Prize Pool Progress
        if (ui.lotteryPoolBar) {
            const poolAmount = lotteryData.prizePool || 0;
            const poolPercent = lotteryData.prizePoolPercent || 0;
            const isReady = lotteryData.isThresholdReached;

            ui.lotteryPoolBar.style.width = `${poolPercent}%`;
            ui.lotteryPoolAmount.innerText = poolAmount.toLocaleString();
            ui.lotteryPoolPercent.innerText = poolPercent.toFixed(2) + '%';

            if (isReady) {
                ui.lotteryPoolBar.classList.remove('from-yellow-500', 'to-orange-500');
                ui.lotteryPoolBar.classList.add('from-green-500', 'to-emerald-500');
                ui.lotteryPoolStatus.innerHTML = 'üéâ <span class="text-green-400 font-bold">THRESHOLD REACHED!</span> Draw will occur at next scheduled time.';
            } else {
                ui.lotteryPoolBar.classList.remove('from-green-500', 'to-emerald-500');
                ui.lotteryPoolBar.classList.add('from-yellow-500', 'to-orange-500');
                const remaining = (lotteryData.prizePoolThreshold || 1000000) - poolAmount;
                ui.lotteryPoolStatus.innerText = `${remaining.toLocaleString()} ASDF remaining to unlock lottery`;
            }
        }
    }

    async function fetchLotteryEligibility() {
        if (!state.pubKey) {
            ui.lotteryStatus.innerText = 'Connect wallet to check';
            ui.lotteryStatus.className = 'text-gray-400';
            ui.lotteryTickets.innerText = '--';
            ui.lotteryActivity.innerText = 'Activity: --/7 days';
            ui.lotteryHoldingInfo.classList.add('hidden');
            return;
        }

        try {
            const res = await fetch(`${API_URL}/lottery/eligibility?user=${state.pubKey.toString()}`);
            if (!res.ok) throw new Error('Failed to fetch eligibility');
            const data = await res.json();

            // Update threshold
            ui.lotteryThreshold.innerText = Math.round(data.threshold).toLocaleString() + ' ASDF';

            // Update tickets (effective tickets with activity multiplier applied)
            ui.lotteryTickets.innerText = data.tickets || 0;

            // Update activity display
            const activeDays = data.activeDays || 0;
            const windowDays = data.activityWindowDays || 7;
            const multiplier = data.activityMultiplier || 0;
            ui.lotteryActivity.innerText = `Activity: ${activeDays}/${windowDays} days (${Math.round(multiplier * 100)}%)`;

            // Color code activity
            if (activeDays >= windowDays) {
                ui.lotteryActivity.className = 'text-[10px] text-green-400 block mt-1';
            } else if (activeDays > 0) {
                ui.lotteryActivity.className = 'text-[10px] text-yellow-400 block mt-1';
            } else {
                ui.lotteryActivity.className = 'text-[10px] text-red-400 block mt-1';
            }

            // Update eligibility status
            if (data.isEligible && data.tickets > 0) {
                ui.lotteryStatus.innerText = 'ELIGIBLE';
                ui.lotteryStatus.className = 'text-green-400 font-bold';
            } else if (data.isEligible && data.tickets === 0) {
                ui.lotteryStatus.innerText = 'NEED ACTIVITY';
                ui.lotteryStatus.className = 'text-yellow-400';
            } else {
                ui.lotteryStatus.innerText = 'NOT ELIGIBLE';
                ui.lotteryStatus.className = 'text-red-400';
            }

            // Show holding info
            ui.lotteryHoldingInfo.classList.remove('hidden');
            ui.lotteryBalance.innerText = Math.round(data.balance).toLocaleString() + ' ASDF';
            ui.lotteryWeeks.innerText = data.weeksHolding || 0;

        } catch (e) {
            console.error('Lottery eligibility error:', e);
            ui.lotteryStatus.innerText = 'Error checking';
            ui.lotteryStatus.className = 'text-red-400';
        }
    }

    // Fetch eligibility periodically (every 60 seconds) when wallet connected
    let lotteryEligibilityInterval = null;
    function startLotteryEligibilityPolling() {
        if (lotteryEligibilityInterval) clearInterval(lotteryEligibilityInterval);
        fetchLotteryEligibility();
        lotteryEligibilityInterval = setInterval(fetchLotteryEligibility, 60000);
    }

    // ==================== REFERRAL SYSTEM ====================
    let referralStatsInterval = null;

    async function fetchReferralStats() {
        if (!state.pubKey) {
            // Reset UI to disconnected state
            if (ui.referralCodeDisplay) ui.referralCodeDisplay.value = '--------';
            if (ui.referralCodeStatus) ui.referralCodeStatus.innerText = 'Connect wallet';
            if (ui.referralCodeMessage) ui.referralCodeMessage.innerText = 'Hold 55,200+ ASDF to create your referral code';
            if (ui.copyCodeBtn) ui.copyCodeBtn.disabled = true;
            if (ui.referralPendingAsdf) ui.referralPendingAsdf.innerText = '0';
            if (ui.referralYourBalance) ui.referralYourBalance.innerText = '0';
            if (ui.referralClaimable) ui.referralClaimable.innerText = '0';
            if (ui.claimBtn) ui.claimBtn.disabled = true;
            if (ui.registerBtn) ui.registerBtn.disabled = true;
            return;
        }

        try {
            const res = await fetch(`${API_URL}/referral/stats?user=${state.pubKey.toString()}`);
            if (!res.ok) throw new Error('Failed to fetch referral stats');
            const data = await res.json();

            // Extract data from nested structure
            const asdfBalance = data.claim?.userASDF_Balance || 0;
            const canCreateCode = asdfBalance >= (data.minASDF || 55200);

            // Update code section
            if (data.referralCode) {
                ui.referralCodeDisplay.value = data.referralCode;
                ui.referralCodeStatus.innerText = '‚úÖ Active';
                ui.referralCodeStatus.className = 'text-xs font-mono text-green-400';
                ui.referralCodeMessage.innerText = `Share to earn 0.448% of referrals' bets`;
                ui.copyCodeBtn.disabled = false;
            } else if (canCreateCode) {
                ui.referralCodeDisplay.value = '--------';
                ui.referralCodeStatus.innerText = 'Click to create';
                ui.referralCodeStatus.className = 'text-xs font-mono text-yellow-400';
                ui.referralCodeMessage.innerHTML = `<button onclick="window.createReferralCode()" class="underline text-cyan-400 hover:text-cyan-300">Click here to create your referral code</button>`;
                ui.copyCodeBtn.disabled = true;
            } else {
                ui.referralCodeDisplay.value = '--------';
                ui.referralCodeStatus.innerText = 'Need 55,200 ASDF';
                ui.referralCodeStatus.className = 'text-xs font-mono text-red-400';
                const needed = (data.minASDF || 55200) - asdfBalance;
                ui.referralCodeMessage.innerText = `Hold ${Math.ceil(needed).toLocaleString()} more ASDF to unlock`;
                ui.copyCodeBtn.disabled = true;
            }

            // Update rewards display (from nested structure)
            const pendingAsdf = data.pending?.totalASDF || 0;
            const claimable = data.claim?.claimableASDF || 0;

            ui.referralPendingAsdf.innerText = pendingAsdf.toLocaleString();
            ui.referralYourBalance.innerText = asdfBalance.toLocaleString();
            ui.referralClaimable.innerText = claimable.toLocaleString();

            // Update claim button
            if (claimable > 0) {
                ui.claimBtn.disabled = false;
                ui.claimBtnText.innerText = `Claim ${claimable.toLocaleString()} ASDF`;
                ui.claimMessage.innerText = '';
            } else if (pendingAsdf > 0 && asdfBalance < pendingAsdf) {
                ui.claimBtn.disabled = true;
                ui.claimBtnText.innerText = 'Claim ASDF Rewards';
                ui.claimMessage.innerHTML = `<span class="text-yellow-400">Hold more ASDF to claim! Need: ${(pendingAsdf - asdfBalance).toLocaleString()} more</span>`;
            } else {
                ui.claimBtn.disabled = true;
                ui.claimBtnText.innerText = 'Claim ASDF Rewards';
                ui.claimMessage.innerText = 'No pending rewards';
            }

            // Update stats
            ui.referralUsersCount.innerText = data.referredUsers || 0;
            ui.referralVolume.innerText = `${(data.totalVolumeGenerated || 0).toFixed(2)} SOL`;
            ui.referralTotalClaimed.innerText = `${(data.pending?.totalClaimedASDF || 0).toLocaleString()} ASDF`;

            // Update referred by
            if (data.referredBy) {
                ui.referralReferredBy.innerText = data.referredBy;
                ui.referralReferredBy.className = 'text-cyan-400';
                ui.registerSection.classList.add('hidden');
            } else {
                ui.referralReferredBy.innerText = 'None';
                ui.referralReferredBy.className = 'text-gray-400';
                ui.registerSection.classList.remove('hidden');
                ui.registerBtn.disabled = false;
            }

        } catch (e) {
            console.error('Referral stats error:', e);
        }
    }

    function startReferralPolling() {
        if (referralStatsInterval) clearInterval(referralStatsInterval);
        fetchReferralStats();
        referralStatsInterval = setInterval(fetchReferralStats, 30000); // Every 30s
    }

    // Copy referral code to clipboard
    window.copyReferralCode = async function() {
        const code = ui.referralCodeDisplay.value;
        if (!code || code === '--------') return;

        try {
            await navigator.clipboard.writeText(code);
            const originalText = ui.copyCodeBtn.innerText;
            ui.copyCodeBtn.innerText = 'Copied!';
            ui.copyCodeBtn.classList.add('bg-green-700');
            setTimeout(() => {
                ui.copyCodeBtn.innerText = originalText;
                ui.copyCodeBtn.classList.remove('bg-green-700');
            }, 2000);
        } catch (e) {
            alert('Failed to copy. Code: ' + code);
        }
    };

    // Create referral code (GET endpoint auto-creates if eligible)
    window.createReferralCode = async function() {
        if (!state.pubKey) {
            alert('Please connect your wallet first');
            return;
        }

        try {
            ui.referralCodeMessage.innerText = 'Creating code...';
            const res = await fetch(`${API_URL}/referral/code?user=${state.pubKey.toString()}`);
            const data = await res.json();

            if (data.code) {
                ui.referralCodeDisplay.value = data.code;
                ui.referralCodeStatus.innerText = '‚úÖ Active';
                ui.referralCodeStatus.className = 'text-xs font-mono text-green-400';
                ui.referralCodeMessage.innerText = data.isNew ? 'Code created! Share to earn rewards.' : 'Your code is ready!';
                ui.copyCodeBtn.disabled = false;
                fetchReferralStats();
            } else if (data.error === 'INSUFFICIENT_ASDF') {
                ui.referralCodeMessage.innerHTML = `<span class="text-red-400">Need ${data.required?.toLocaleString() || '55,200'} ASDF (you have ${data.current?.toLocaleString() || 0})</span>`;
            } else {
                ui.referralCodeMessage.innerHTML = `<span class="text-red-400">${data.error || 'Failed to create code'}</span>`;
            }
        } catch (e) {
            console.error('Create code error:', e);
            ui.referralCodeMessage.innerHTML = `<span class="text-red-400">Error creating code</span>`;
        }
    };

    // Register with a referral code
    window.registerReferralCode = async function() {
        if (!state.pubKey) {
            alert('Please connect your wallet first');
            return;
        }

        const code = ui.registerCodeInput.value.trim().toUpperCase();
        if (!code || code.length !== 8) {
            ui.registerMessage.innerHTML = '<span class="text-red-400">Please enter a valid 8-character code</span>';
            return;
        }

        try {
            ui.registerBtn.disabled = true;
            ui.registerMessage.innerText = 'Registering...';

            const res = await fetch(`${API_URL}/referral/register`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    user: state.pubKey.toString(),
                    code: code
                })
            });
            const data = await res.json();

            if (data.success) {
                ui.registerMessage.innerHTML = '<span class="text-green-400">‚úÖ Successfully registered!</span>';
                ui.registerSection.classList.add('hidden');
                fetchReferralStats();
            } else {
                ui.registerMessage.innerHTML = `<span class="text-red-400">${data.error || 'Registration failed'}</span>`;
                ui.registerBtn.disabled = false;
            }
        } catch (e) {
            console.error('Register error:', e);
            ui.registerMessage.innerHTML = `<span class="text-red-400">Error registering code</span>`;
            ui.registerBtn.disabled = false;
        }
    };

    // Claim referral rewards
    window.claimReferralRewards = async function() {
        if (!state.pubKey) {
            alert('Please connect your wallet first');
            return;
        }

        try {
            ui.claimBtn.disabled = true;
            ui.claimBtnText.innerText = 'Claiming...';
            ui.claimMessage.innerText = '';

            const res = await fetch(`${API_URL}/referral/claim`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ user: state.pubKey.toString() })
            });
            const data = await res.json();

            if (data.success) {
                const claimed = Math.round(data.claimedASDF || 0);
                ui.claimMessage.innerHTML = `<span class="text-green-400">‚úÖ Claimed ${claimed.toLocaleString()} ASDF!</span>`;
                if (data.txSignature) {
                    ui.claimMessage.innerHTML += ` <a href="https://solscan.io/tx/${data.txSignature}" target="_blank" class="underline text-cyan-400">View TX</a>`;
                }
                // Refresh stats
                setTimeout(fetchReferralStats, 2000);
            } else {
                ui.claimMessage.innerHTML = `<span class="text-red-400">${data.error || 'Claim failed'}</span>`;
            }
        } catch (e) {
            console.error('Claim error:', e);
            ui.claimMessage.innerHTML = `<span class="text-red-400">Error claiming rewards</span>`;
        } finally {
            ui.claimBtnText.innerText = 'Claim ASDF Rewards';
            fetchReferralStats();
        }
    };
    // ==================== END REFERRAL SYSTEM ====================

    async function poll() {
        // Prevent polling if tab hidden (redundant check for safety)
        if (document.hidden) return;
        
        // Safety guard: Ensure UI is initialized
        if (!ui || !ui.price) return;

        try {
            let url = `${API_URL}/state`;
            if(state.pubKey) url += `?user=${state.pubKey.toString()}`;
            const res = await fetch(url);
            
            // HANDLE 503 (INITIALIZING)
            if(res.status === 503) {
                 ui.statusText.innerText = "INITIALIZING"; 
                 ui.statusText.className = "text-blue-400 animate-pulse";
                 ui.topStatus.className = "flex items-center gap-2 text-xs font-mono bg-black/40 px-3 py-2 rounded border border-blue-900/50";
                 return; 
            }

            if(!res.ok) throw new Error(res.statusText);
            const data = await res.json();
            
            state.isOnline = true;
            // UPDATE: Reset status display to default
            ui.statusText.innerText = "ONLINE"; 
            ui.statusText.className = "text-green-400";
            ui.topStatus.className = "flex items-center gap-2 text-xs font-mono bg-black/40 px-3 py-2 rounded border border-green-900/50 transition-colors duration-500";
            if(ui.lastUpdated && data.lastPriceTimestamp) ui.lastUpdated.innerText = `Price Data: ${new Date(data.lastPriceTimestamp).toLocaleTimeString()}`;
            if(data.backendVersion) ui.backendVersion.innerText = `v${data.backendVersion}`;

            // --- STATE SYNC ---
            state.isResetting = data.isResetting;
            state.isCancelled = data.isCancelled;

            if (data.isResetting) {
                ui.netSharesHeader.innerText = "CALCULATING RESULTS..."; ui.netSharesHeader.classList.add("text-blue-400", "animate-pulse"); ui.netSharesHeader.classList.remove("text-red-500");
                // Disable buy buttons and show overlay
                ui.pauseOverlay.classList.remove('hidden');
                ui.statusText.innerText = "RESETTING"; ui.statusText.className = "text-blue-400";
                if(ui.pauseText) { ui.pauseText.innerText = "CALCULATING RESULTS..."; ui.pauseText.className = "text-blue-400 font-bold text-xl"; }
                ui.timer.innerText = "Resetting..."; // Immediate feedback
            }
            else if (data.isCancelled) {
                ui.netSharesHeader.innerText = "FRAME CANCELLED"; ui.netSharesHeader.classList.add("text-red-500"); 
                // Disable buy buttons and show overlay
                ui.pauseOverlay.classList.remove('hidden');
                ui.statusText.innerText = "CANCELLED"; ui.statusText.className = "text-red-500";
                if(ui.pauseText) { ui.pauseText.innerText = "FRAME CANCELLED - funds refunded"; ui.pauseText.className = "text-red-500 font-bold text-xl"; }
            }
            else if (data.isPaused) {
                ui.netSharesHeader.innerText = "MARKET PAUSED"; ui.netSharesHeader.classList.add("text-red-500"); 
                // Disable buy buttons and show overlay
                ui.pauseOverlay.classList.remove('hidden');
                ui.statusText.innerText = "PAUSED"; ui.statusText.className = "text-yellow-500";
                ui.topStatus.className = "flex items-center gap-2 text-xs font-mono bg-black/40 px-3 py-2 rounded border border-yellow-900/50";
                if(ui.pauseText) { ui.pauseText.innerText = "FRAME PAUSED"; ui.pauseText.className = "text-yellow-500 font-bold text-xl"; }
            } else {
                // LOCAL LOCKDOWN CHECK
                if (state.targetEndTime && state.targetEndTime <= Date.now() + 500) {
                     // Local timer says closed, waiting for backend
                     ui.netSharesHeader.innerText = "CALCULATING RESULTS..."; ui.netSharesHeader.classList.add("text-blue-400", "animate-pulse");
                     // Disable buy buttons and show overlay
                     ui.pauseOverlay.classList.remove('hidden');
                     if(ui.pauseText) { ui.pauseText.innerText = "CALCULATING RESULTS..."; ui.pauseText.className = "text-blue-400 font-bold text-xl"; }
                } else {
                     // OPEN
                     ui.netSharesHeader.innerText = "Share Market"; ui.netSharesHeader.classList.remove("text-red-500", "text-blue-400", "animate-pulse");
                     // Re-enable buy buttons and hide overlay
                     ui.pauseOverlay.classList.add('hidden');
                }
            }

            try {
                if (data.market) {
                    state.prices = { up: data.market.priceUp, down: data.market.priceDown };
                    if(data.market.changes) { formatChange(ui.up1m, data.market.changes.up1m); formatChange(ui.up5m, data.market.changes.up5m); formatChange(ui.down1m, data.market.changes.down1m); formatChange(ui.down5m, data.market.changes.down5m); }
                    const nU = Math.max(0, data.market.sharesUp-50), nD = Math.max(0, data.market.sharesDown-50);
                    ui.lblSharesUp.innerText = nU.toFixed(0); ui.lblSharesDown.innerText = nD.toFixed(0);
                    const total = nU + nD || 1;
                    ui.barUp.style.width = `${(nU/total)*100}%`; ui.barDown.style.width = `${(nD/total)*100}%`;
                    ui.lblPriceUp.innerText = state.prices.up.toFixed(3); ui.lblPriceDown.innerText = state.prices.down.toFixed(3);
                }

                ui.price.innerText = `$${data.price.toFixed(2)}`;
                const diff = data.price - data.openPrice;
                const color = diff >= 0 ? 'text-green-400' : 'text-red-500';
                ui.change.innerHTML = `<span class="${color}">${diff>=0?'+':''}${diff.toFixed(2)} (${data.change.toFixed(2)}%)</span>`;

                if(data.candleStartTime) {
                     ui.frameStart.innerText = new Date(data.candleStartTime).toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'});
                     ui.frameEnd.innerText = new Date(data.candleEndTime).toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'});
                     state.targetEndTime = data.candleEndTime;
                }

                const ms = data.msUntilClose;
                // ui.timer.innerText update moved to updateTimer()
                if(data.currentVolume !== undefined) ui.currentPot.innerText = `${data.currentVolume.toFixed(3)} SOL`;

                state.fullHistory = data.history || [];

                // UPDATE: Fill new stats fields with Fallbacks
                if(data.platformStats) {
                    // RESTORED OLD STATS (Fixes Ghost Element Bug)
                    // Using || 0 ensures no "undefined" or "NaN" if data is fresh
                    if (ui.statGlobalVol) ui.statGlobalVol.innerText = `${(data.platformStats.totalVolume || 0).toFixed(2)} SOL`;
                    if (ui.statGlobalFees) ui.statGlobalFees.innerText = `${(data.platformStats.totalFees || 0).toFixed(3)} SOL`;
                    if (ui.statGlobalASDF) ui.statGlobalASDF.innerText = Math.round(data.platformStats.totalASDF || 0).toLocaleString() + " ASDF";
                }

                // New Fields
                if (data.uniqueUsers !== undefined) ui.frameUsers.innerText = data.uniqueUsers;
                if (data.totalLifetimeUsers) ui.globalLifetimeUsers.innerText = data.totalLifetimeUsers.toLocaleString();
                if (data.totalWinnings !== undefined) ui.globalWinnings.innerText = `${data.totalWinnings.toFixed(2)} SOL`;

                if (data.lastFramePot !== undefined) {
                    const statusIcon = data.payoutQueueLength === 0 ? "‚úÖ" : "‚è≥";
                    // Using innerText preserves the styling of the anchor tag
                    ui.globalLastPayout.innerText = `${statusIcon} ${data.lastFramePot.toFixed(2)} SOL`;
                }

                if (data.broadcast && data.broadcast.isActive && data.broadcast.message) {
                    ui.broadcastContainer.classList.remove('hidden');
                    ui.broadcastText.innerText = data.broadcast.message;
                } else {
                    ui.broadcastContainer.classList.add('hidden');
                }

                // RE-ADD LEADERBOARD LOGIC - ENSURE IT CALLS
                if(data.leaderboard) renderLeaderboard(data.leaderboard);
                if(data.recentTrades) renderTicker(data.recentTrades);

                // Lottery UI Update (from feature branch)
                if(data.lottery) updateLotteryUI(data.lottery);

                // UPDATE: SENTIMENT UI (POLLING)
                if (data.hourlySentiment) {
                    const sUp = data.hourlySentiment.up;
                    const sDown = data.hourlySentiment.down;
                    const sTotal = sUp + sDown || 1;
                    ui.valSentUp.innerText = sUp;
                    ui.valSentDown.innerText = sDown;

                    // FIX: Progress Bar Calculation
                    const upPercent = sTotal > 0 ? (sUp / sTotal) * 100 : 50;
                    ui.sentBarFill.style.width = `${upPercent}%`;

                    if (sUp > sDown) { ui.sentBarFill.style.backgroundColor = '#22c55e'; }
                    else if (sDown > sUp) { ui.sentBarFill.style.backgroundColor = '#ef4444'; }
                    else { ui.sentBarFill.style.backgroundColor = '#fb923c'; }

                    // Calc Time
                    const now = Date.now();
                    if (data.hourlySentiment.nextReset > now) {
                         const totalSeconds = Math.floor((data.hourlySentiment.nextReset - now) / 1000);
                         const mins = Math.floor(totalSeconds / 60); // Updated to min only for hourly/daily
                         const hours = Math.floor(mins / 60);
                         const displayMins = mins % 60;
                         ui.sentTimer.innerText = `Reset: ${hours}h ${displayMins}m`;
                    } else {
                         ui.sentTimer.innerText = `Resetting...`;
                    }
                }

                // FIX: Image Population
                if (state.images.sentUp) ui.imgSentUp.src = state.images.sentUp; else ui.imgSentUp.style.display='none';
                if (state.images.sentDown) ui.imgSentDown.src = state.images.sentDown; else ui.imgSentDown.style.display='none';


                if(data.userStats) {
                    state.userLog = data.userStats.frameLog || {};
                    ui.statsContainer.classList.remove('hidden');
                    const total = data.userStats.wins + data.userStats.losses;
                    const rate = total > 0 ? ((data.userStats.wins/total)*100).toFixed(0) : 0;
                    ui.statWin.innerText = `${rate}% (${data.userStats.wins}/${total})`;
                    ui.statVol.innerText = `${data.userStats.totalSol.toFixed(3)} SOL`;

                    // LAST FRAME PERF (Check if Closed)
                    if (state.fullHistory.length > 0) {
                        const last = state.fullHistory[0];
                        const nowTime = Date.now();
                        if (last.endTime < nowTime && state.userLog[last.id]) {
                             const log = state.userLog[last.id];
                             let res = log.result === 'WIN' ? `<span class="text-green-400">WIN</span>` : `<span class="text-red-400">LOSS</span>`;
                             if (log.result === 'CANCELLED') res = `<span class="text-yellow-500">REFUNDED</span>`;
                             // UPDATE: Check for Refunded Error
                             if (log.result === 'REFUNDED_ERROR') res = `<span class="text-yellow-500 font-bold">‚ö†Ô∏è REFUNDED</span>`;

                             // TEXT UPDATE
                             // UPDATE: Change "Vol" to "My Wager"
                             ui.lastFrameStats.innerHTML = `
                                <div class="flex justify-between"><span>My Wager:</span> <span>${(log.wagered || 0).toFixed(3)} SOL</span></div>
                                <div class="flex justify-between text-[10px] border-t border-white/10 pt-1 mt-1">
                                    <span class="text-green-400">UP: ${Math.round(log.upShares||0)}</span> <span class="text-red-400">DOWN: ${Math.round(log.downShares||0)}</span>
                                </div>
                                <div class="flex justify-between border-t border-white/10 mt-1 pt-1"><span>Result:</span> ${res}</div>
                             `;

                             // IMAGE UPDATE removed by request

                        } else {
                            // FIX: If user is connected but hasn't played or frame is active/pending close
                            ui.lastFrameStats.innerHTML = `<span class="italic opacity-50">Waiting for close...</span>`;
                        }
                    } else {
                         // User is connected, but no history data yet
                         ui.lastFrameStats.innerHTML = `<span class="italic opacity-50">Waiting for first game...</span>`;
                    }
                }
                renderHistory();
                // renderLeaderboard call is handled above
                if(data.recentTrades) renderTicker(data.recentTrades);

                if(data.activePosition) {
                    const uS = data.activePosition.upShares || 0;
                    const uV = data.activePosition.upSol || 0;
                    const dS = data.activePosition.downShares || 0;
                    const dV = data.activePosition.downSol || 0;

                    // CORRECTED FORMAT: Assign Shares and SOL to their respective, mapped elements
                    if (ui.statActUp) ui.statActUp.innerText = Math.round(uS);
                    if (ui.statActUpSol) ui.statActUpSol.innerText = `(${uV.toFixed(2)} SOL)`;

                    if (ui.statActDown) ui.statActDown.innerText = Math.round(dS);
                    if (ui.statActDownSol) ui.statActDownSol.innerText = `(${dV.toFixed(2)} SOL)`;

                    const pot = (data.currentVolume || 0) * 0.94;
                    let est = 0;
                    if (data.market) {
                        if (uS > dS) {
                            const totalRealUp = Math.max(1, data.market.sharesUp - 50);
                            est = (uS / totalRealUp) * pot;
                        } else if (dS > uS) {
                            const totalRealDown = Math.max(1, data.market.sharesDown - 50);
                            est = (dS / totalRealDown) * pot;
                        }
                    }
                    ui.statPayout.innerText = est.toFixed(3) + " SOL";
                }
            } catch(e) { console.log("Stats Render Error", e); }

            // CRUCIAL: Re-run costs update after new market data (prices/status) is fetched
            updateCosts();

        } catch(e) {
            console.error(e);
            state.isOnline = false;
            // Removed custom messaging here to let the status indicator default
            if(ui.topStatus) ui.topStatus.className = "flex items-center gap-2 text-xs font-mono bg-black/40 px-3 py-2 rounded border border-red-900/50 transition-colors duration-500";
            if(ui.statusText) { ui.statusText.innerText = "OFFLINE"; ui.statusText.className = "text-red-500"; }
            updateCosts(); // Still need to run this to handle disabling if offline
        } finally {
            // Recursive polling with Jitter
            // If WebSocket is connected, poll less frequently (fallback only)
            const baseInterval = (ws && ws.readyState === WebSocket.OPEN) ? 10000 : 2000;
            const jitter = Math.floor(Math.random() * 400);
            pollTimeout = setTimeout(poll, baseInterval + jitter);
        }
    }

    // ==================== WEBSOCKET CLIENT ====================
    function initWebSocket() {
        // Determine WebSocket URL from API_URL
        const wsProtocol = location.protocol === 'https:' ? 'wss:' : 'ws:';
        const wsHost = API_URL.includes('localhost')
            ? 'localhost:3000'
            : 'asdforecast.onrender.com';
        const wsUrl = `${wsProtocol}//${wsHost}`;

        try {
            ws = new WebSocket(wsUrl);
        } catch (e) {
            console.error('[WS] Failed to create WebSocket:', e);
            return;
        }

        ws.onopen = () => {
            console.log('[WS] Connected');
            wsReconnectAttempts = 0;

            // Authenticate with pubKey if connected
            if (state.pubKey) {
                ws.send(JSON.stringify({ type: 'AUTH', pubKey: state.pubKey.toString() }));
            }

            // Update status indicator
            if (ui.statusText) {
                ui.statusText.innerText = "LIVE";
                ui.statusText.className = "text-green-400";
            }
        };

        ws.onmessage = (event) => {
            try {
                const msg = JSON.parse(event.data);
                handleWebSocketMessage(msg);
            } catch (e) {
                console.error('[WS] Message parse error:', e);
            }
        };

        ws.onclose = () => {
            console.log('[WS] Disconnected');
            ws = null;

            // Reconnect with exponential backoff
            const delay = Math.min(1000 * Math.pow(2, wsReconnectAttempts++), WS_RECONNECT_MAX_DELAY);
            console.log(`[WS] Reconnecting in ${delay}ms...`);
            setTimeout(initWebSocket, delay);
        };

        ws.onerror = (e) => {
            console.error('[WS] Error:', e);
        };
    }

    function handleWebSocketMessage(msg) {
        const { event, data, ts } = msg;

        switch (event) {
            case 'STATE':
                processStateUpdate(data);
                break;
            case 'PRICE':
                // Quick price update (lighter than full state)
                if (ui.price && data.price) {
                    ui.price.innerText = data.price.toFixed(2);
                    if (ui.change && data.change !== undefined) {
                        const changeClass = data.change >= 0 ? 'text-green-400' : 'text-red-400';
                        ui.change.innerText = `${data.change >= 0 ? '+' : ''}${data.change.toFixed(4)}%`;
                        ui.change.className = changeClass;
                    }
                }
                break;
            case 'FRAME_CLOSE':
                // Frame result notification
                console.log('[WS] Frame closed:', data.result, 'Winners:', data.winners);
                // The STATE update will follow with full data
                break;
            case 'SERVER_SHUTDOWN':
                // Server is shutting down
                console.warn('[WS] Server shutdown:', data.message);
                if (ui.statusText) {
                    ui.statusText.innerText = "MAINTENANCE";
                    ui.statusText.className = "text-yellow-500 animate-pulse";
                }
                if (ui.pauseOverlay) {
                    ui.pauseOverlay.classList.remove('hidden');
                }
                if (ui.pauseText) {
                    ui.pauseText.innerText = "Server maintenance in progress...";
                    ui.pauseText.className = "text-yellow-500 font-bold text-xl";
                }
                break;
            default:
                console.log('[WS] Unknown event:', event);
        }
    }

    function processStateUpdate(data) {
        // Same logic as poll() but from WebSocket
        if (!ui || !ui.price) return;

        state.isOnline = true;
        if (ui.statusText) {
            ui.statusText.innerText = "LIVE";
            ui.statusText.className = "text-green-400";
        }
        if (ui.topStatus) {
            ui.topStatus.className = "flex items-center gap-2 text-xs font-mono bg-black/40 px-3 py-2 rounded border border-green-900/50 transition-colors duration-500";
        }
        if (ui.lastUpdated && data.lastPriceTimestamp) {
            ui.lastUpdated.innerText = `Price Data: ${new Date(data.lastPriceTimestamp).toLocaleTimeString()}`;
        }
        if (data.backendVersion) {
            ui.backendVersion.innerText = `v${data.backendVersion}`;
        }

        // --- STATE SYNC (same as poll) ---
        state.isResetting = data.isResetting;
        state.isCancelled = data.isCancelled;

        if (data.isResetting) {
            ui.netSharesHeader.innerText = "CALCULATING RESULTS...";
            ui.netSharesHeader.classList.add("text-blue-400", "animate-pulse");
            ui.netSharesHeader.classList.remove("text-red-500");
            ui.pauseOverlay.classList.remove('hidden');
            ui.statusText.innerText = "RESETTING";
            ui.statusText.className = "text-blue-400";
            if (ui.pauseText) {
                ui.pauseText.innerText = "CALCULATING RESULTS...";
                ui.pauseText.className = "text-blue-400 font-bold text-xl";
            }
            ui.timer.innerText = "Resetting...";
        } else if (data.isCancelled) {
            ui.netSharesHeader.innerText = "FRAME CANCELLED";
            ui.netSharesHeader.classList.add("text-red-500");
            ui.pauseOverlay.classList.remove('hidden');
            ui.statusText.innerText = "CANCELLED";
            ui.statusText.className = "text-red-500";
            if (ui.pauseText) {
                ui.pauseText.innerText = "FRAME CANCELLED - funds refunded";
                ui.pauseText.className = "text-red-500 font-bold text-xl";
            }
        } else if (data.isPaused) {
            ui.netSharesHeader.innerText = "MARKET PAUSED";
            ui.netSharesHeader.classList.add("text-red-500");
            ui.pauseOverlay.classList.remove('hidden');
            ui.statusText.innerText = "PAUSED";
            ui.statusText.className = "text-yellow-500";
            if (ui.pauseText) {
                ui.pauseText.innerText = "MARKET PAUSED";
                ui.pauseText.className = "text-yellow-500 font-bold text-xl";
            }
        } else {
            ui.netSharesHeader.innerText = "MARKET LIVE";
            ui.netSharesHeader.classList.remove("text-red-500", "text-blue-400", "animate-pulse");
            ui.pauseOverlay.classList.add('hidden');
        }

        // Update prices
        if (data.price) ui.price.innerText = data.price.toFixed(2);
        if (data.change !== undefined) {
            const changeClass = data.change >= 0 ? 'text-green-400' : 'text-red-400';
            ui.change.innerText = `${data.change >= 0 ? '+' : ''}${data.change.toFixed(4)}%`;
            ui.change.className = changeClass;
        }

        // Update market data
        if (data.market) {
            state.prices.up = data.market.priceUp;
            state.prices.down = data.market.priceDown;
            updateCosts();

            const totalShares = data.market.sharesUp + data.market.sharesDown;
            const pctUp = Math.round((data.market.sharesUp / totalShares) * 100);
            const pctDown = 100 - pctUp;

            if (ui.barUp) ui.barUp.style.width = `${pctUp}%`;
            if (ui.barDown) ui.barDown.style.width = `${pctDown}%`;
            if (ui.lblSharesUp) ui.lblSharesUp.innerText = Math.floor(data.market.sharesUp);
            if (ui.lblSharesDown) ui.lblSharesDown.innerText = Math.floor(data.market.sharesDown);
            if (ui.lblPriceUp) ui.lblPriceUp.innerText = state.prices.up.toFixed(4);
            if (ui.lblPriceDown) ui.lblPriceDown.innerText = state.prices.down.toFixed(4);
        }

        // Update frame times
        if (data.candleStartTime && data.candleEndTime) {
            state.targetEndTime = data.candleEndTime;
            if (ui.frameStart) ui.frameStart.innerText = new Date(data.candleStartTime).toLocaleTimeString();
            if (ui.frameEnd) ui.frameEnd.innerText = new Date(data.candleEndTime).toLocaleTimeString();
        }

        // Update history if available
        if (data.history && Array.isArray(data.history)) {
            state.fullHistory = data.history;
            renderHistoryTable(data.history);
        }

        // Update lottery if available
        if (data.lottery && ui.lotteryPool) {
            ui.lotteryPool.innerText = (data.lottery.prizePool || 0).toLocaleString();
        }
    }
    // ==================== END WEBSOCKET CLIENT ====================

    async function buy(dir) {

        // LOCAL LOCKDOWN

        if (state.targetEndTime && state.targetEndTime <= Date.now() + 500) {

            alert("Market has closed. Calculating results.");
            return;

        }

        if(!state.isOnline) return alert("System Offline");

        const qty = parseInt(ui.qty.value);

        const cost = qty * (dir==='UP'?state.prices.up:state.prices.down);
        
        // FINAL VALIDATION CHECK
        if (cost > state.solBalance) {
            alert(`Insufficient funds. Cost is ${cost.toFixed(4)} SOL but you only have ${state.solBalance.toFixed(4)} SOL.`);
            return;
        }

        const btn = dir==='UP'?ui.btnUp:ui.btnDown;

        const old = btn.innerHTML;

        btn.innerHTML = "SIGNING..."; btn.disabled = true;

        try {

            const tx = new Transaction();

            const { blockhash } = await state.conn.getLatestBlockhash();

            tx.recentBlockhash = blockhash; tx.feePayer = state.pubKey;

            tx.add(SystemProgram.transfer({ fromPubkey: state.pubKey, toPubkey: new PublicKey(HOUSE_PUBKEY), lamports: Math.round(cost * solanaWeb3.LAMPORTS_PER_SOL) }));

            const sig = await window.solana.signAndSendTransaction(tx);

            btn.innerHTML = "VERIFYING...";

            await state.conn.confirmTransaction(sig.signature, 'confirmed');

            const res = await fetch(`${API_URL}/verify-bet`, { method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify({ signature: sig.signature, direction: dir, userPubKey: state.pubKey.toString() }) });

            const d = await res.json();

            if(d.success) { 
                alert(`Bought ${Math.round(d.shares)} shares!`);
                refreshBalance(); 
            } else { 
                alert(d.error);
            }

        } catch(e) { 
            console.error(e); 
            alert("Tx Failed");
        } finally { btn.innerHTML = old; btn.disabled = false; updateCosts(); } // Re-enable and update costs/disable state

    }
</script>
