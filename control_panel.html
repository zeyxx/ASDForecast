<!-- ASDForecast CONTROL PANEL v1.4 // LOTTERY + BROADCAST MERGE -->

<script src="https://cdn.tailwindcss.com"></script>
<link href="https://fonts.googleapis.com/css2?family=Comic+Neue:wght@400;700&family=JetBrains+Mono:wght@400;700&display=swap" rel="stylesheet">

<style>
    body { background-color: #0c0c0c; color: #ffedd5; font-family: 'JetBrains Mono', monospace; }
    .panel { background: #1a0f0a; border: 2px solid #7c2d12; border-radius: 8px; padding: 20px; box-shadow: 4px 4px 0 #9a3412; }
    .stat-label { color: #fb923c; font-size: 0.75rem; text-transform: uppercase; letter-spacing: 0.05em; margin-bottom: 4px; }
    .stat-value { font-size: 1.5rem; font-weight: bold; color: #fff; }
    .history-scroll { max-height: 400px; overflow-y: auto; }
    .history-scroll::-webkit-scrollbar { width: 6px; }
    .history-scroll::-webkit-scrollbar-thumb { background: #ea580c; border-radius: 3px; }
    
    /* DEBUG LOG STYLE */
    #debug-log-container {
        height: 200px;
        overflow-y: auto;
        font-size: 10px;
        background-color: #000;
        border: 1px solid #333;
        padding: 10px;
        color: #0f0;
        white-space: pre-wrap;
    }
    #debug-log-container::-webkit-scrollbar { width: 6px; }
    #debug-log-container::-webkit-scrollbar-thumb { background: #333; }

    .blink { animation: blink 1s infinite; }
    @keyframes blink { 50% { opacity: 0.5; } }

    /* MODAL STYLE */
    .modal-backdrop {
        background: rgba(0, 0, 0, 0.8);
        backdrop-filter: blur(4px);
    }
</style>

<div class="max-w-7xl mx-auto p-6">
    
    <!-- HEADER -->
    <div class="flex flex-col md:flex-row justify-between items-center mb-8 border-b border-orange-900 pb-4 gap-4">
        <div>
            <h1 class="text-2xl font-bold text-orange-500">ASDForecast // CONTROL PANEL</h1>
            <p class="text-xs text-gray-500">Admin Telemetry & Emergency Controls</p>
        </div>
        
        <div class="flex items-center gap-6">

            <!-- BROADCAST CONTROLS -->
            <div class="flex items-center gap-2 bg-gray-900 p-2 rounded border border-gray-700">
                <input type="text" id="broadcast-msg" placeholder="Broadcast Message..." class="bg-black text-white text-xs p-2 rounded border border-gray-600 w-48">
                <button onclick="updateBroadcast(true)" class="bg-blue-900 border border-blue-500 text-blue-200 px-3 py-1 rounded text-xs font-bold hover:bg-blue-600">ON</button>
                <button onclick="updateBroadcast(false)" class="bg-gray-800 border border-gray-600 text-gray-400 px-3 py-1 rounded text-xs font-bold hover:bg-gray-700">OFF</button>
            </div>
            
            <!-- PAUSE CONTROLS -->
            <div class="flex items-center gap-3 bg-gray-900 p-2 rounded border border-gray-700">
                <div class="text-right">
                    <div class="text-[10px] text-gray-400 uppercase">Game State</div>
                    <div id="game-state-indicator" class="text-sm font-bold text-gray-500">CONNECTING...</div>
                </div>
                <button onclick="togglePause()" class="bg-yellow-900 border border-yellow-500 text-yellow-200 px-4 py-2 rounded text-xs font-bold hover:bg-yellow-600 hover:text-white transition-colors uppercase">
                    ‚è∏ Switch
                </button>
            </div>

            <!-- EMERGENCY CANCEL -->
            <button onclick="cancelFrame()" class="bg-red-900 border border-red-500 text-red-200 px-4 py-2 rounded text-xs font-bold hover:bg-red-600 hover:text-white transition-colors uppercase">
                ‚ö†Ô∏è Cancel
            </button>

            <!-- LOTTERY DRAW -->
            <button onclick="triggerLotteryDraw()" class="bg-purple-900 border border-purple-500 text-purple-200 px-4 py-2 rounded text-xs font-bold hover:bg-purple-600 hover:text-white transition-colors uppercase">
                üéüÔ∏è Lottery Draw
            </button>

            <!-- CONNECTION STATUS -->
            <div id="status-box" class="flex items-center gap-2 px-3 py-1 bg-black border border-gray-800 rounded h-10">
                <span class="w-2 h-2 rounded-full bg-gray-500" id="status-dot"></span>
                <span class="text-xs" id="status-text">OFFLINE</span>
            </div>
        </div>
    </div>

    <!-- LIVE STATS GRID -->
    <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
        <div class="panel"> <div class="stat-label">Current Frame Volume</div> <div id="val-volume" class="stat-value">0.00 SOL</div> </div>
        <div class="panel"> <div class="stat-label">Active Wallets</div> <div id="val-users" class="stat-value">0</div> </div>
        <div class="panel"> <div class="stat-label">Time Remaining</div> <div id="val-timer" class="stat-value text-yellow-400">--:--</div> </div>
        <div class="panel"> <div class="stat-label">SOL Price</div> <div id="val-price" class="stat-value">$0.00</div> </div>
    </div>

    <!-- LOTTERY STATUS -->
    <div class="panel mb-8 border-purple-900/50">
        <h3 class="text-purple-400 font-bold mb-4 border-b border-purple-900/30 pb-2">üéüÔ∏è LOTTERY STATUS</h3>
        <div class="grid grid-cols-4 gap-4">
            <div>
                <div class="stat-label text-purple-700">Current Round</div>
                <div id="val-lottery-round" class="text-xl font-bold text-white">#--</div>
            </div>
            <div>
                <div class="stat-label text-purple-700">Next Draw</div>
                <div id="val-lottery-countdown" class="text-xl font-bold text-purple-400">--</div>
            </div>
            <div>
                <div class="stat-label text-purple-700">Last Winner</div>
                <div id="val-lottery-winner" class="text-xl font-bold text-green-400">--</div>
            </div>
            <div>
                <div class="stat-label text-purple-700">Last Prize</div>
                <div id="val-lottery-prize" class="text-xl font-bold text-yellow-400">-- ASDF</div>
            </div>
        </div>
    </div>

    <!-- MARKET DEPTH -->
    <div class="grid grid-cols-1 md:grid-cols-2 gap-8 mb-8">
        <!-- UP SIDE -->
        <div class="panel border-green-900/50">
            <h3 class="text-green-500 font-bold mb-4 border-b border-green-900/30 pb-2">UP POOL üìà</h3>
            <div class="grid grid-cols-2 gap-4">
                <div class="bg-green-900/20 p-4 rounded border border-green-900/50"> 
                    <div class="stat-label text-green-500">UP Price</div> <div id="val-up-price" class="text-xl font-bold text-white">0.000 SOL</div>
                    <div class="stat-label text-green-500 mt-2">Shares</div> <div id="val-up-shares" class="text-xl font-bold text-white">0</div>
                </div>
                <div class="bg-red-900/20 p-4 rounded border border-red-900/50"> 
                    <div class="stat-label text-red-500">DOWN Price</div> <div id="val-down-price" class="text-xl font-bold text-white">0.000 SOL</div>
                    <div class="stat-label text-red-500 mt-2">Shares</div> <div id="val-down-shares" class="text-xl font-bold text-white">0</div>
                </div>
            </div>
        </div>
        
        <!-- LOGS PANEL -->
        <div class="panel bg-black/40 flex flex-col">
            <div class="flex justify-between items-center mb-2">
                <h3 class="text-sm font-bold text-white">Live Debug Logs</h3>
                <span class="text-[10px] text-gray-500">Auto-scrolling</span>
            </div>
            <div id="debug-log-container" class="flex-grow">Waiting for logs...</div>
        </div>
    </div>

    <!-- PAYOUT MONITOR SECTION -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8">
        <!-- ACTIVE QUEUE -->
        <div class="panel bg-black/40">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-bold text-yellow-500">Active Payout Queue</h3>
                <span id="queue-count" class="text-xs text-yellow-600 font-bold">0 Batches</span>
            </div>
            <div class="history-scroll h-64 border border-yellow-900/30 rounded bg-black/20 p-2">
                <table class="w-full text-xs font-mono text-left">
                    <thead class="text-gray-500 border-b border-gray-800">
                        <tr><th class="pb-2">Type</th><th class="pb-2">Recipients</th><th class="pb-2">Retries</th></tr>
                    </thead>
                    <tbody id="queue-rows" class="text-gray-300"><tr><td colspan="3" class="py-2 text-center italic opacity-50">Queue Empty</td></tr></tbody>
                </table>
            </div>
        </div>

        <!-- PAYOUT HISTORY -->
        <div class="panel bg-black/40">
             <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-bold text-green-500">Payout History</h3>
                <button onclick="fetchPayouts()" class="text-xs text-green-600 hover:text-white">[ REFRESH ]</button>
            </div>
            <div class="history-scroll h-64 border border-green-900/30 rounded bg-black/20 p-2">
                <table class="w-full text-xs font-mono text-left">
                    <thead class="text-gray-500 border-b border-gray-800">
                        <tr><th class="pb-2">Time</th><th class="pb-2">Type</th><th class="pb-2">Amt (SOL)</th><th class="pb-2">Tx</th></tr>
                    </thead>
                    <tbody id="payout-history-rows" class="text-gray-300"><tr><td colspan="4" class="py-2 text-center italic opacity-50">No History</td></tr></tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- FRAME HISTORY PANEL -->
    <div class="panel bg-black/40">
        <div class="flex justify-between items-center mb-4">
            <h3 class="text-lg font-bold text-white">Frame History</h3>
            <button onclick="openFullHistory()" class="text-xs bg-orange-900 text-orange-200 px-3 py-1 rounded hover:bg-orange-800 font-bold">VIEW ALL ‚§¢</button>
        </div>
        <div id="history-container" class="history-scroll">
            <table class="w-full text-xs font-mono text-left">
                <thead class="text-orange-500 border-b border-orange-900/50 sticky top-0 bg-black">
                    <tr>
                        <th class="pb-2 pl-2">Time (Close)</th>
                        <th class="pb-2">Result</th>
                        <th class="pb-2 text-right">Vol</th>
                        <th class="pb-2 text-right">Winners</th>
                        <th class="pb-2 text-right">Payout</th>
                    </tr>
                </thead>
                <tbody id="history-rows" class="text-orange-200/80 divide-y divide-orange-900/20">
                    <tr><td colspan="5" class="py-4 text-center italic opacity-50">Loading history...</td></tr>
                </tbody>
            </table>
        </div>
    </div>

    <!-- FULL HISTORY MODAL (UPDATED V1.8: ADDED OPEN/CLOSE) -->
    <div id="full-history-modal" class="fixed inset-0 z-50 hidden modal-backdrop flex items-center justify-center" onclick="if(event.target === this) this.classList.add('hidden')">
        <div class="bg-[#1a0f0a] border-2 border-orange-600 rounded-lg w-11/12 h-5/6 max-w-6xl flex flex-col shadow-2xl" onclick="event.stopPropagation()">
            <div class="p-4 border-b border-orange-900 flex justify-between items-center bg-black/50">
                <h2 class="text-xl font-bold text-white">FULL FRAME HISTORY</h2>
                <div class="flex gap-4">
                    <input type="text" id="history-search" placeholder="Search ID or Result..." class="bg-black text-white text-xs p-2 rounded border border-gray-700" onkeyup="filterHistory()">
                    <button onclick="document.getElementById('full-history-modal').classList.add('hidden')" class="text-gray-400 hover:text-white text-xl">‚úï</button>
                </div>
            </div>
            <div class="flex-grow overflow-y-auto p-4" id="full-history-content">
                <table class="w-full text-xs font-mono text-left">
                    <thead class="text-orange-500 border-b border-orange-900 sticky top-0 bg-[#1a0f0a]">
                        <tr>
                            <th class="pb-2 pl-2">Time (Close)</th>
                            <th class="pb-2">Result</th>
                            <!-- ADDED OPEN/CLOSE -->
                            <th class="pb-2 text-right">Open</th>
                            <th class="pb-2 text-right">Close</th>
                            
                            <th class="pb-2 text-right">Vol</th>
                            <th class="pb-2 text-right">Fee</th>
                            <th class="pb-2 text-right">Upkeep</th>
                            <th class="pb-2 text-right">Users</th>
                            <th class="pb-2 text-right">Payout</th>
                            <th class="pb-2 text-right">Vault Œî</th>
                        </tr>
                    </thead>
                    <tbody id="full-history-rows" class="text-orange-200/80 divide-y divide-orange-900/20">
                        <!-- Populated via JS -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <div class="mt-8 text-center text-xs text-gray-600">
        <p>Backend Connection: <span class="font-mono text-orange-900">https://asdforecast.onrender.com</span></p>
    </div>

</div>

<script>
    const IS_LOCAL = ['localhost', '127.0.0.1'].includes(window.location.hostname) || window.location.hostname.includes('github.dev');
    const API_URL = IS_LOCAL
        ? (window.location.hostname.includes('github.dev')
            ? window.location.origin.replace('-8080.', '-3000.') + '/api'
            : 'http://localhost:3000/api')
        : 'https://asdforecast.onrender.com/api';
    
    let fullHistory = [];
    let cachedAdminPassword = null;
    let isLogAutoScroll = true;
    let allFramesData = [];

    const ui = {
        statusDot: document.getElementById('status-dot'),
        statusText: document.getElementById('status-text'),
        gameStateIndicator: document.getElementById('game-state-indicator'),
        vol: document.getElementById('val-volume'),
        users: document.getElementById('val-users'),
        timer: document.getElementById('val-timer'),
        price: document.getElementById('val-price'),
        upPrice: document.getElementById('val-up-price'),
        upShares: document.getElementById('val-up-shares'),
        downPrice: document.getElementById('val-down-price'),
        downShares: document.getElementById('val-down-shares'),
        broadcastMsg: document.getElementById('broadcast-msg'),
        logsContainer: document.getElementById('debug-log-container'),
        queueRows: document.getElementById('queue-rows'),
        queueCount: document.getElementById('queue-count'),
        payoutHistoryRows: document.getElementById('payout-history-rows'),
        historyRows: document.getElementById('history-rows'),
        historyContainer: document.getElementById('history-container'),
        btnExpand: document.getElementById('btn-expand-history'),
        // Lottery UI
        lotteryRound: document.getElementById('val-lottery-round'),
        lotteryCountdown: document.getElementById('val-lottery-countdown'),
        lotteryWinner: document.getElementById('val-lottery-winner'),
        lotteryPrize: document.getElementById('val-lottery-prize')
    };

    function getPassword() {
        if (cachedAdminPassword) return cachedAdminPassword;
        const pwd = prompt("ENTER ADMIN ACTION PASSWORD:");
        if (pwd) cachedAdminPassword = pwd;
        return pwd;
    }

    // --- ADMIN ACTIONS ---
    async function togglePause() {
        const pwd = getPassword();
        if (!pwd) return;
        try {
            const res = await fetch(`${API_URL}/admin/toggle-pause`, {
                method: 'POST',
                headers: { 'x-admin-secret': pwd }
            });
            const data = await res.json();
            if (data.success) alert(`SUCCESS: Market is now ${data.isPaused ? "PAUSED" : "ACTIVE"}`);
            else { alert("Error: " + data.error); cachedAdminPassword = null; }
        } catch (e) { alert("Network Error"); }
    }

    async function cancelFrame() {
        if (!confirm("‚ö†Ô∏è DANGER: CANCEL THIS FRAME? This refunds 99% of bets and PAUSES the market.")) return;

        const pwd = prompt("ENTER ADMIN ACTION PASSWORD:");
        if (!pwd) return;
        try {
            const res = await fetch(`${API_URL}/admin/cancel-frame`, {
                method: 'POST',
                headers: { 'x-admin-secret': pwd }
            });
            const data = await res.json();
            if (data.success) alert("Frame Cancelled. Market Paused.");
            else { alert("Error: " + data.error); cachedAdminPassword = null; }
        } catch (e) { alert("Network Error"); }
    }

    async function updateBroadcast(isActive) {
        const msg = ui.broadcastMsg.value;
        if (!msg && isActive) return alert("Please enter a message first.");
        const pwd = prompt("ENTER ADMIN ACTION PASSWORD:");
        if (!pwd) return;
        try {
            const res = await fetch(`${API_URL}/admin/broadcast`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'x-admin-secret': pwd },
                body: JSON.stringify({ message: msg, isActive: isActive })
            });
            const data = await res.json();
            if (data.success) alert(`Broadcast Updated: ${isActive ? "ON" : "OFF"}`);
            else alert("Error: " + data.error);
        } catch (e) { alert("Network Error"); }
    }

    async function triggerLotteryDraw() {
        if (!confirm("üéüÔ∏è TRIGGER MANUAL LOTTERY DRAW? This will select a winner now regardless of schedule.")) return;

        const pwd = prompt("ENTER ADMIN ACTION PASSWORD:");
        if (!pwd) return;

        try {
            const res = await fetch(`${API_URL}/admin/lottery/draw`, {
                method: 'POST',
                headers: { 'x-admin-secret': pwd }
            });
            const data = await res.json();
            if (data.success) {
                alert(`üéâ LOTTERY DRAW COMPLETE!\n\nRound: ${data.round}\nWinner: ${data.winner.slice(0,8)}...\nPrize: ${data.prize.toLocaleString()} ASDF\nTotal Tickets: ${data.totalTickets}\nParticipants: ${data.participantCount}`);
            } else {
                alert("Draw failed: " + (data.reason || data.error));
            }
        } catch (e) {
            console.error(e);
            alert("Network Error");
        }
    }

    function formatLotteryCountdown(ms) {
        if (ms <= 0) return "NOW";
        const days = Math.floor(ms / (24 * 60 * 60 * 1000));
        const hours = Math.floor((ms % (24 * 60 * 60 * 1000)) / (60 * 60 * 1000));
        const mins = Math.floor((ms % (60 * 60 * 1000)) / (60 * 1000));
        if (days > 0) return `${days}d ${hours}h`;
        if (hours > 0) return `${hours}h ${mins}m`;
        return `${mins}m`;
    }

    async function poll() {
        try {
            const res = await fetch(`${API_URL}/state`);
            const data = await res.json();

            // Connection Status
            ui.statusDot.classList.remove('bg-gray-500', 'bg-red-500');
            ui.statusDot.classList.add('bg-green-500', 'blink');
            ui.statusText.innerText = "ONLINE";
            ui.statusText.classList.remove('text-red-500');
            ui.statusText.classList.add('text-green-500');

            // Game State Indicator
            if(data.isPaused) {
                 ui.gameStateIndicator.innerText = "PAUSED ‚è∏";
                 ui.gameStateIndicator.className = "text-base font-bold text-yellow-500 animate-pulse";
            } else if (data.isResetting) {
                 ui.gameStateIndicator.innerText = "RESETTING ‚è≥";
                 ui.gameStateIndicator.className = "text-base font-bold text-blue-400 animate-pulse";
            } else {
                 ui.gameStateIndicator.innerText = "ACTIVE üü¢";
                 ui.gameStateIndicator.className = "text-base font-bold text-green-500";
            }

            if (data.currentVolume !== undefined) ui.vol.innerText = `${data.currentVolume.toFixed(4)} SOL`;
            if (data.uniqueUsers !== undefined) ui.users.innerText = data.uniqueUsers;
            if (data.price) ui.price.innerText = `$${data.price.toFixed(2)}`;

            if (data.msUntilClose) {
                const m = Math.floor((data.msUntilClose % (1000 * 60 * 60)) / (1000 * 60));
                const s = Math.floor((data.msUntilClose % (1000 * 60)) / 1000);
                ui.timer.innerText = `${m}:${s.toString().padStart(2, '0')}`;
            }

            if (data.market) {
                // FIXED: Append units to Market Depth
                ui.upPrice.innerText = `${data.market.priceUp.toFixed(4)} SOL`;
                ui.downPrice.innerText = `${data.market.priceDown.toFixed(4)} SOL`;
                const netUp = Math.max(0, data.market.sharesUp - 50);
                const netDown = Math.max(0, data.market.sharesDown - 50);
                ui.upShares.innerText = Math.round(netUp).toLocaleString();
                ui.downShares.innerText = Math.round(netDown).toLocaleString();
            }
            
            // Render Small History in Panel
            if (data.history) {
                ui.historyRows.innerHTML = data.history.slice(0, 3).map(f => {
                     const time = new Date(f.endTime || f.time).toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'});
                     let resColor = f.result==='UP'?'text-green-400':(f.result==='DOWN'?'text-red-400':(f.result==='CANCELLED'?'text-red-600 font-bold':(f.result==='PAUSED'?'text-yellow-500 font-bold':'text-gray-400')));
                     return `<tr class="hover:bg-white/5"><td class="py-3 pl-2">${time}</td><td class="py-3 ${resColor}">${f.result}</td><td class="py-3 text-right">${(f.totalSol||0).toFixed(2)}</td><td class="py-3 text-right">${f.winners||0}</td><td class="py-3 text-right">${(f.payout||0).toFixed(2)}</td></tr>`;
                }).join('');
            }

            // Update lottery UI
            if (data.lottery) {
                ui.lotteryRound.innerText = '#' + (data.lottery.currentRound || '--');
                ui.lotteryCountdown.innerText = formatLotteryCountdown(data.lottery.msUntilDraw || 0);

                if (data.lottery.recentWinner) {
                    ui.lotteryWinner.innerText = data.lottery.recentWinner.slice(0, 8) + '...';
                    ui.lotteryPrize.innerText = (data.lottery.recentPrize || 0).toLocaleString() + ' ASDF';
                } else {
                    ui.lotteryWinner.innerText = 'No draws yet';
                    ui.lotteryPrize.innerText = '-- ASDF';
                }
            }

        } catch (e) {
            ui.statusDot.classList.remove('bg-green-500', 'blink');
            ui.statusDot.classList.add('bg-red-500');
            ui.statusText.innerText = "DISCONNECTED";
            ui.statusText.classList.remove('text-green-500');
            ui.statusText.classList.add('text-red-500');
            ui.gameStateIndicator.innerText = "UNKNOWN";
            ui.gameStateIndicator.className = "text-sm font-bold text-gray-500";
        }
    }

    ui.logsContainer.addEventListener('scroll', () => {
        if (ui.logsContainer.scrollTop + ui.logsContainer.clientHeight < ui.logsContainer.scrollHeight - 10) {
            isLogAutoScroll = false;
        } else {
            isLogAutoScroll = true;
        }
    });

    // --- MISSING FUNCTIONS ---
    async function fetchLogs() {
        try {
            const pwd = cachedAdminPassword;
            if (!pwd) return;
            const res = await fetch(`${API_URL}/admin/logs`, {
                headers: { 'x-admin-secret': pwd }
            });
            const data = await res.json();
            if (data.error) return;
            if (data.logs && Array.isArray(data.logs)) {
                ui.logsContainer.innerHTML = data.logs.slice(-100).map(log => {
                    const time = new Date(log.timestamp || Date.now()).toLocaleTimeString();
                    return `<div>[${time}] ${log.level || 'INFO'}: ${log.message}</div>`;
                }).join('');
                if (isLogAutoScroll) {
                    ui.logsContainer.scrollTop = ui.logsContainer.scrollHeight;
                }
            }
        } catch (e) {
            console.error('fetchLogs error:', e);
        }
    }

    async function fetchPayouts() {
        try {
            const pwd = cachedAdminPassword;
            if (!pwd) return;
            const res = await fetch(`${API_URL}/admin/payouts`, {
                headers: { 'x-admin-secret': pwd }
            });
            const data = await res.json();
            if (data.error) return;

            // Update queue
            if (data.queue && Array.isArray(data.queue)) {
                ui.queueCount.innerText = `${data.queue.length} Batches`;
                if (data.queue.length === 0) {
                    ui.queueRows.innerHTML = '<tr><td colspan="3" class="py-2 text-center italic opacity-50">Queue Empty</td></tr>';
                } else {
                    ui.queueRows.innerHTML = data.queue.map(item =>
                        `<tr><td class="py-1">${item.type || 'PAYOUT'}</td><td class="py-1">${item.recipients || item.count || 0}</td><td class="py-1">${item.retries || 0}</td></tr>`
                    ).join('');
                }
            }

            // Update history
            if (data.history && Array.isArray(data.history)) {
                if (data.history.length === 0) {
                    ui.payoutHistoryRows.innerHTML = '<tr><td colspan="4" class="py-2 text-center italic opacity-50">No History</td></tr>';
                } else {
                    ui.payoutHistoryRows.innerHTML = data.history.slice(0, 20).map(p => {
                        const time = new Date(p.timestamp || p.time).toLocaleTimeString();
                        const txShort = p.signature ? p.signature.slice(0, 8) + '...' : '--';
                        return `<tr><td class="py-1">${time}</td><td class="py-1">${p.type || 'WIN'}</td><td class="py-1">${(p.amount || 0).toFixed(4)}</td><td class="py-1"><a href="https://solscan.io/tx/${p.signature}" target="_blank" class="text-blue-400 hover:underline">${txShort}</a></td></tr>`;
                    }).join('');
                }
            }
        } catch (e) {
            console.error('fetchPayouts error:', e);
        }
    }

    async function openFullHistory() {
        document.getElementById('full-history-modal').classList.remove('hidden');
        try {
            const pwd = cachedAdminPassword || prompt("ENTER ADMIN PASSWORD:");
            if (!pwd) return;
            cachedAdminPassword = pwd;

            const res = await fetch(`${API_URL}/admin/full-history`, {
                headers: { 'x-admin-secret': pwd }
            });
            const data = await res.json();
            if (data.error) {
                alert('Error: ' + data.error);
                cachedAdminPassword = null;
                return;
            }

            allFramesData = data.history || data || [];
            renderFullHistory(allFramesData);
        } catch (e) {
            console.error('openFullHistory error:', e);
        }
    }

    function renderFullHistory(frames) {
        const rows = document.getElementById('full-history-rows');
        if (!frames || frames.length === 0) {
            rows.innerHTML = '<tr><td colspan="10" class="py-4 text-center italic opacity-50">No history available</td></tr>';
            return;
        }
        rows.innerHTML = frames.map(f => {
            const time = new Date(f.endTime || f.time).toLocaleString();
            let resColor = f.result === 'UP' ? 'text-green-400' : (f.result === 'DOWN' ? 'text-red-400' : 'text-gray-400');
            const vaultDelta = ((f.fee || 0) + (f.upkeep || 0)).toFixed(4);
            return `<tr class="hover:bg-white/5">
                <td class="py-2 pl-2">${time}</td>
                <td class="py-2 ${resColor}">${f.result || '--'}</td>
                <td class="py-2 text-right">$${(f.open || 0).toFixed(2)}</td>
                <td class="py-2 text-right">$${(f.close || 0).toFixed(2)}</td>
                <td class="py-2 text-right">${(f.totalSol || 0).toFixed(2)}</td>
                <td class="py-2 text-right">${(f.fee || 0).toFixed(4)}</td>
                <td class="py-2 text-right">${(f.upkeep || 0).toFixed(4)}</td>
                <td class="py-2 text-right">${f.users || 0}</td>
                <td class="py-2 text-right">${(f.payout || 0).toFixed(2)}</td>
                <td class="py-2 text-right text-yellow-400">${vaultDelta}</td>
            </tr>`;
        }).join('');
    }

    function filterHistory() {
        const search = document.getElementById('history-search').value.toLowerCase();
        if (!search) {
            renderFullHistory(allFramesData);
            return;
        }
        const filtered = allFramesData.filter(f => {
            const id = String(f.id || f.startTime || '').toLowerCase();
            const result = (f.result || '').toLowerCase();
            return id.includes(search) || result.includes(search);
        });
        renderFullHistory(filtered);
    }

    window.onload = () => {
        // Prompt for admin password on load
        cachedAdminPassword = prompt("ENTER ADMIN PASSWORD (for logs/payouts):");

        poll(); // Start public data polling immediately
        setInterval(poll, 2000);

        if (cachedAdminPassword) {
            fetchLogs();
            fetchPayouts();
            setInterval(fetchLogs, 5000);
            setInterval(fetchPayouts, 5000);
        }

        // ESCAPE KEY TO CLOSE MODAL
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                document.getElementById('full-history-modal')?.classList.add('hidden');
            }
        });
    };
</script>
