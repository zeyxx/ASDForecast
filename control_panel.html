<!-- ASDForecast CONTROL PANEL v1.0 -->

<script src="https://cdn.tailwindcss.com"></script>
<link href="https://fonts.googleapis.com/css2?family=Comic+Neue:wght@400;700&family=JetBrains+Mono:wght@400;700&display=swap" rel="stylesheet">

<style>
    body { background-color: #0c0c0c; color: #ffedd5; font-family: 'JetBrains Mono', monospace; }
    .panel { background: #1a0f0a; border: 2px solid #7c2d12; border-radius: 8px; padding: 20px; box-shadow: 4px 4px 0 #9a3412; }
    .stat-label { color: #fb923c; font-size: 0.75rem; text-transform: uppercase; letter-spacing: 0.05em; margin-bottom: 4px; }
    .stat-value { font-size: 1.5rem; font-weight: bold; color: #fff; }
    .history-scroll { max-height: 500px; overflow-y: auto; }
    .history-scroll::-webkit-scrollbar { width: 6px; }
    .history-scroll::-webkit-scrollbar-thumb { background: #ea580c; border-radius: 3px; }
    .blink { animation: blink 1s infinite; }
    @keyframes blink { 50% { opacity: 0.5; } }
</style>

<div class="max-w-6xl mx-auto p-6">
    
    <!-- HEADER -->
    <div class="flex flex-col md:flex-row justify-between items-center mb-8 border-b border-orange-900 pb-4 gap-4">
        <div>
            <h1 class="text-2xl font-bold text-orange-500">ASDForecast // CONTROL PANEL</h1>
            <p class="text-xs text-gray-500">Admin Telemetry & Emergency Controls</p>
        </div>
        
        <div class="flex items-center gap-6">
            
            <!-- PAUSE CONTROLS -->
            <div class="flex items-center gap-3 bg-gray-900 p-2 rounded border border-gray-700">
                <div class="text-right">
                    <div class="text-[10px] text-gray-400 uppercase">Game State</div>
                    <div id="game-state-indicator" class="text-sm font-bold text-gray-500">CONNECTING...</div>
                </div>
                <button onclick="togglePause()" class="bg-yellow-900 border border-yellow-500 text-yellow-200 px-4 py-2 rounded text-xs font-bold hover:bg-yellow-600 hover:text-white transition-colors uppercase">
                    ‚è∏ Switch
                </button>
            </div>

            <!-- EMERGENCY CANCEL -->
            <button onclick="cancelFrame()" class="bg-red-900 border border-red-500 text-red-200 px-4 py-2 rounded text-xs font-bold hover:bg-red-600 hover:text-white transition-colors uppercase">
                ‚ö†Ô∏è Cancel & Refund
            </button>

            <!-- CONNECTION STATUS -->
            <div id="status-box" class="flex items-center gap-2 px-3 py-1 bg-black border border-gray-800 rounded h-10">
                <span class="w-2 h-2 rounded-full bg-gray-500" id="status-dot"></span>
                <span class="text-xs" id="status-text">OFFLINE</span>
            </div>
        </div>
    </div>

    <!-- LIVE STATS GRID -->
    <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
        <div class="panel"> <div class="stat-label">Current Frame Volume</div> <div id="val-volume" class="stat-value">0.00 SOL</div> </div>
        <div class="panel"> <div class="stat-label">Active Wallets</div> <div id="val-users" class="stat-value">0</div> </div>
        <div class="panel"> <div class="stat-label">Time Remaining</div> <div id="val-timer" class="stat-value text-yellow-400">--:--</div> </div>
        <div class="panel"> <div class="stat-label">SOL Price</div> <div id="val-price" class="stat-value">$0.00</div> </div>
    </div>

    <!-- MARKET DEPTH -->
    <div class="grid grid-cols-1 md:grid-cols-2 gap-8 mb-8">
        <!-- UP SIDE -->
        <div class="panel border-green-900/50">
            <h3 class="text-green-500 font-bold mb-4 border-b border-green-900/30 pb-2">UP POOL üìà</h3>
            <div class="grid grid-cols-2 gap-4">
                <div> <div class="stat-label text-green-700">Share Price</div> <div id="val-up-price" class="text-xl font-bold text-green-400">0.000 SOL</div> </div>
                <div> <div class="stat-label text-green-700">Net Shares</div> <div id="val-up-shares" class="text-xl font-bold text-white">0</div> </div>
            </div>
        </div>
        <!-- DOWN SIDE -->
        <div class="panel border-red-900/50">
            <h3 class="text-red-500 font-bold mb-4 border-b border-red-900/30 pb-2">DOWN POOL üî•</h3>
            <div class="grid grid-cols-2 gap-4">
                <div> <div class="stat-label text-red-700">Share Price</div> <div id="val-down-price" class="text-xl font-bold text-red-400">0.000 SOL</div> </div>
                <div> <div class="stat-label text-red-700">Net Shares</div> <div id="val-down-shares" class="text-xl font-bold text-white">0</div> </div>
            </div>
        </div>
    </div>

    <!-- HISTORY PANEL -->
    <div class="panel bg-black/40">
        <div class="flex justify-between items-center mb-4">
            <h3 class="text-lg font-bold text-white">Frame History</h3>
        </div>
        <div id="history-container" class="history-scroll">
            <table class="w-full text-xs font-mono text-left">
                <thead class="text-orange-500 border-b border-orange-900/50 sticky top-0 bg-black">
                    <tr>
                        <th class="pb-2 pl-2">Time</th>
                        <th class="pb-2">Result</th>
                        <th class="pb-2 text-right">Vol</th>
                        <th class="pb-2 text-right">Winners</th>
                        <th class="pb-2 text-right">Payout</th>
                        <th class="pb-2 text-center">Action</th>
                    </tr>
                </thead>
                <tbody id="history-rows" class="text-orange-200/80 divide-y divide-orange-900/20">
                    <tr><td colspan="6" class="py-4 text-center italic opacity-50">Loading history...</td></tr>
                </tbody>
            </table>
        </div>

        <!-- EXPAND BUTTON -->
        <button id="btn-expand-history" onclick="toggleHistory()" class="w-full py-3 text-xs text-orange-500/50 hover:text-orange-500 hover:bg-orange-900/20 mt-2 font-mono border-t border-dashed border-orange-900/30 transition-colors hidden">
            [ + ] EXPAND FULL HISTORY
        </button>
    </div>

    <div class="mt-8 text-center text-xs text-gray-600">
        <p>Backend Connection: <span class="font-mono text-orange-900">https://asdforecast.onrender.com</span></p>
    </div>

</div>

<script>
    const API_URL = 'https://asdforecast.onrender.com/api';
    const HOUSE_PUBKEY = "BXSp5y6Ua6tB5fZDe1EscVaaEaZLg1yqzrsPqAXhKJYy"; 
    
    let fullHistory = [];
    let isHistoryExpanded = false;

    const ui = {
        statusDot: document.getElementById('status-dot'),
        statusText: document.getElementById('status-text'),
        gameStateIndicator: document.getElementById('game-state-indicator'),
        vol: document.getElementById('val-volume'),
        users: document.getElementById('val-users'),
        timer: document.getElementById('val-timer'),
        price: document.getElementById('val-price'),
        upPrice: document.getElementById('val-up-price'),
        upShares: document.getElementById('val-up-shares'),
        downPrice: document.getElementById('val-down-price'),
        downShares: document.getElementById('val-down-shares'),
        historyRows: document.getElementById('history-rows'),
        historyContainer: document.getElementById('history-container'),
        btnExpand: document.getElementById('btn-expand-history')
    };

    function toggleHistory() {
        isHistoryExpanded = !isHistoryExpanded;
        if (isHistoryExpanded) {
            ui.btnExpand.innerText = "[ - ] COLLAPSE HISTORY";
            ui.historyContainer.classList.remove('history-collapsed');
            ui.historyContainer.classList.add('history-scroll');
        } else {
            ui.btnExpand.innerText = "[ + ] EXPAND FULL HISTORY";
            ui.historyContainer.classList.remove('history-scroll');
        }
        renderHistory();
    }

    function renderHistory() {
        if (!fullHistory || fullHistory.length === 0) {
            ui.historyRows.innerHTML = '<tr><td colspan="6" class="py-4 text-center italic opacity-50">No history available.</td></tr>';
            return;
        }

        const dataToShow = isHistoryExpanded ? fullHistory : fullHistory.slice(0, 3);

        ui.historyRows.innerHTML = dataToShow.map(f => {
            const time = new Date(f.time).toLocaleString([], { month: 'short', day: 'numeric', hour: '2-digit', minute:'2-digit' });
            
            let resColor = 'text-gray-400';
            if (f.result === 'UP') resColor = 'text-green-400 font-bold';
            if (f.result === 'DOWN') resColor = 'text-red-400 font-bold';
            if (f.result === 'CANCELLED') resColor = 'text-red-600 font-bold';
            if (f.result === 'PAUSED') resColor = 'text-yellow-500 font-bold';

            const solscanLink = `https://solscan.io/account/${HOUSE_PUBKEY}`;

            return `
                <tr class="hover:bg-white/5 transition-colors">
                    <td class="py-3 pl-2">${time}</td>
                    <td class="py-3 ${resColor}">${f.result}</td>
                    <td class="py-3 text-right font-bold">${(f.totalSol || 0).toFixed(3)}</td>
                    <td class="py-3 text-right">${f.winners || 0}</td>
                    <td class="py-3 text-right text-green-400">${(f.payout || 0).toFixed(3)}</td>
                    <td class="py-3 text-center">
                        <a href="${solscanLink}" target="_blank" class="text-[10px] bg-orange-900/30 text-orange-400 px-2 py-1 rounded hover:bg-orange-500 hover:text-black transition-colors">
                            View Ledger ‚Üó
                        </a>
                    </td>
                </tr>
            `;
        }).join('');

        if (fullHistory.length > 3) {
            ui.btnExpand.classList.remove('hidden');
        }
    }

    // --- ADMIN ACTIONS ---
    async function togglePause() {
        // Prompt user for password; Backend checks this against ADMIN_ACTION_PASSWORD env var
        const pwd = prompt("ENTER ADMIN ACTION PASSWORD TO PAUSE/RESUME:");
        if (!pwd) return;

        try {
            const res = await fetch(`${API_URL}/admin/toggle-pause`, {
                method: 'POST',
                headers: { 'x-admin-secret': pwd }
            });
            const data = await res.json();
            if (data.success) alert(`SUCCESS: Market is now ${data.isPaused ? "PAUSED" : "ACTIVE"}`);
            else alert("Error: " + data.error);
        } catch (e) { alert("Network Error"); }
    }

    async function cancelFrame() {
        if (!confirm("‚ö†Ô∏è DANGER: CANCEL THIS FRAME? This refunds 99% of bets and PAUSES the market.")) return;
        
        const pwd = prompt("ENTER ADMIN ACTION PASSWORD:");
        if (!pwd) return;

        try {
            const res = await fetch(`${API_URL}/admin/cancel-frame`, {
                method: 'POST',
                headers: { 'x-admin-secret': pwd } 
            });
            const data = await res.json();
            if (data.success) alert("Frame Cancelled. Market Paused.");
            else alert("Error: " + data.error);
        } catch (e) { alert("Network Error"); }
    }

    async function poll() {
        try {
            const res = await fetch(`${API_URL}/state`);
            const data = await res.json();

            // Connection Status
            ui.statusDot.classList.remove('bg-gray-500', 'bg-red-500');
            ui.statusDot.classList.add('bg-green-500', 'blink');
            ui.statusText.innerText = "ONLINE";
            ui.statusText.classList.remove('text-red-500');
            ui.statusText.classList.add('text-green-500');

            // Game State Indicator (New)
            if(data.isPaused) {
                 ui.gameStateIndicator.innerText = "PAUSED ‚è∏";
                 ui.gameStateIndicator.className = "text-base font-bold text-yellow-500 animate-pulse";
            } else if (data.isResetting) {
                 ui.gameStateIndicator.innerText = "RESETTING ‚è≥";
                 ui.gameStateIndicator.className = "text-base font-bold text-blue-400 animate-pulse";
            } else {
                 ui.gameStateIndicator.innerText = "ACTIVE üü¢";
                 ui.gameStateIndicator.className = "text-base font-bold text-green-500";
            }

            if (data.currentVolume !== undefined) ui.vol.innerText = `${data.currentVolume.toFixed(4)} SOL`;
            if (data.uniqueUsers !== undefined) ui.users.innerText = data.uniqueUsers;
            if (data.price) ui.price.innerText = `$${data.price.toFixed(2)}`;

            if (data.msUntilClose) {
                const m = Math.floor((data.msUntilClose % (1000 * 60 * 60)) / (1000 * 60));
                const s = Math.floor((data.msUntilClose % (1000 * 60)) / 1000);
                ui.timer.innerText = `${m}:${s.toString().padStart(2, '0')}`;
            }

            if (data.market) {
                ui.upPrice.innerText = data.market.priceUp.toFixed(4) + " SOL";
                ui.downPrice.innerText = data.market.priceDown.toFixed(4) + " SOL";
                
                const netUp = Math.max(0, data.market.sharesUp - 50);
                const netDown = Math.max(0, data.market.sharesDown - 50);
                
                ui.upShares.innerText = Math.round(netUp).toLocaleString();
                ui.downShares.innerText = Math.round(netDown).toLocaleString();
            }

            fullHistory = data.history || [];
            renderHistory();

        } catch (e) {
            ui.statusDot.classList.remove('bg-green-500', 'blink');
            ui.statusDot.classList.add('bg-red-500');
            ui.statusText.innerText = "DISCONNECTED";
            ui.statusText.classList.remove('text-green-500');
            ui.statusText.classList.add('text-red-500');
            ui.gameStateIndicator.innerText = "UNKNOWN";
            ui.gameStateIndicator.className = "text-sm font-bold text-gray-500";
        }
    }

    setInterval(poll, 2000);
    poll();
</script>
